function Tipsy(t,e){this.jq_element=$(t),this.options=$.extend({},this.defaults,e)}"undefined"!=typeof google&&google.load("visualization","1",{packages:[]}),"function"!=typeof sendLog&&(sendLog=null);var kshf={queryURL_base:"https://docs.google.com/spreadsheet/tq?key=",surrogateCtor:function(){},extendClass:function(t,e){this.surrogateCtor.prototype=t.prototype,e.prototype=new this.surrogateCtor,e.prototype.constructor=e},num_of_charts:0,maxVisibleItems_default:50,dt:{},dt_id:{},dt_ColNames:{},dt_ColNames_Arr:{},createColumnNames:function(t){this.dt_ColNames[t]={},this.dt_ColNames_Arr[t]=[]},insertColumnName:function(t,e,i){this.dt_ColNames[t][e]=i,this.dt_ColNames_Arr[t][i]=e},LOG:{CONFIG:1,FILTER_ADD:10,FILTER_CLEAR:11,FILTER_CLEAR_ALL:12,FILTER_ATTR_ADD_AND:13,FILTER_ATTR_ADD_OR:14,FILTER_ATTR_ADD_ONE:15,FILTER_ATTR_ADD_OR_ALL:16,FILTER_ATTR_ADD_NOT:17,FILTER_ATTR_EXACT:18,FILTER_ATTR_UNSELECT:19,FILTER_TEXTSEARCH:20,FILTER_INTRVL_HANDLE:21,FILTER_INTRVL_BIN:22,FILTER_CLEAR_X:23,FILTER_CLEAR_CRUMB:24,FILTER_PREVIEW:25,FACET_COLLAPSE:40,FACET_SHOW:41,FACET_SORT:42,FACET_SCROLL_TOP:43,FACET_SCROLL_MORE:44,LIST_SORT:50,LIST_SCROLL_TOP:51,LIST_SHOWMORE:52,ITEM_DETAIL_ON:60,ITEM_DETAIL_OFF:61,DATASOURCE:70,INFOBOX:71,CLOSEPAGE:72,BARCHARTWIDTH:73,RESIZE:74}};kshf.Util={dif_itemCount_Active:function(t,e){return e.itemCount_Active-t.itemCount_Active},sortFunc_ActiveCount_TotalCount:function(t,e){var i=kshf.Util.dif_itemCount_Active(t,e);return 0===i?e.items.length-t.items.length:i},sortFunc_Column_Int_Incr:function(t,e){return t.data[1]-e.data[1]},sortFunc_Column_Int_Decr:function(t,e){return e.data[1]-t.data[1]},sortFunc_Column_ParseInt_Incr:function(t,e){return parseFloat(t.data[1],10)-parseFloat(e.data[1],10)},sortFunc_Column_ParseInt_Decr:function(t,e){return parseFloat(e.data[1],10)-parseFloat(t.data[1],10)},sortFunc_String_Decr:function(t,e){return e.data[1].localeCompare(t.data[1])},sortFunc_String_Incr:function(t,e){return e.data[1].localeCompare(t.data[1])},sortFunc_Time_Last:function(t,e){return void 0!==t.xMax_Dyn&&void 0!==e.xMax_Dyn?e.xMax_Dyn-t.xMax_Dyn:void 0===t.xMax_Dyn&&void 0===e.xMax_Dyn?e.xMax-t.xMax:void 0===e.xMax_Dyn?-1:1},sortFunc_Time_First:function(t,e){return void 0!==t.xMax_Dyn&&void 0!==e.xMax_Dyn?t.xMin_Dyn-e.xMin_Dyn:void 0===t.xMax_Dyn&&void 0===e.xMax_Dyn?t.xMin-e.xMin:void 0===e.xMin_Dyn?-1:1},sortFunc_List_String:function(t,e){return t.localeCompare(e)},sortFunc_List_Date:function(t,e){return null===t?-1:null===e?1:t.getTime()-e.getTime()},sortFunc_List_Number:function(t,e){return e-t},cellToArray:function(t,e,i,s){void 0===i&&(i=/\b\s+/);var a;t.forEach(function(t){t=t.data,e.forEach(function(e){var r=t[e];if(null!==r&&"number"!=typeof r){var o=r.split(i);for(r=[],a=0;a<o.length;a++)o[a]=o[a].trim(),""!==o[a]&&r.push(o[a]);if(s!==!1)for(a=0;a<r.length;a++)r[a]=parseInt(r[a],10);t[e]=r}})})},unescapeCommas:function(t){var e,i=!1,s=[];return t.forEach(function(t){if(i){if(e+=","+t,'"'!==t[t.length-1])return;i=!1}else{if('"'===t[0])return i=!0,e=t.slice(1,t.length-1),void 0;e=t}var a=+e;isNaN(a)||""===e||(e=a),s.push(e)}),s},formatForItemCount:function(t){if(1e3>t)return t;if(1e6>t){var e=t/1e3;return 10>e?Math.floor(t/100)/10+"k":Math.floor(e)+"k"}return 1e9>t?Math.floor(t/1e6)+"m":t},nearestYear:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),0,1));return t.getUTCMonth()>6&&e.setUTCFullYear(e.getUTCFullYear()+1),e},nearestMonth:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),1));return t.getUTCDate()>15&&e.setUTCMonth(e.getUTCMonth()+1),e},nearestDay:function(t){var e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));return t.getUTCHours()>12&&e.setUTCDate(e.getUTCDate()+1),e},nearestHour:function(){},nearestMinute:function(){},filter_multi_or:function(t){var e=!1;return t.every(function(t){return t.f_included()&&(e=!0),!e}),e},filter_multi_and:function(t){var e=0;return t.forEach(function(t){t.f_included()&&e++}),e===this.attribCount_Included},filter_multi_removed:function(t){return!t.every(function(t){return!t.f_removed()})},ignoreScrollEvents:!1,scrollToPos_do:function(t,e){kshf.Util.ignoreScrollEvents=!0;var i=null,s=t.scrollTop,a=d3.ease("cubic-in-out"),r=500,o=function(n){var l;null===i&&(i=n),l=(n-i)/r;var h=a(l);t.scrollTop=(1-h)*s+h*e,t.scrollTop!==e?window.requestAnimationFrame(o):kshf.Util.ignoreScrollEvents=!1};window.requestAnimationFrame(o)},toProperCase:function(t){var e=t.toLowerCase();return e.replace(/\b[a-z]/g,function(t){return t.toUpperCase()})},insertSlider_do:function(t,e){var i=function(){return e.filter.active.min!==e.range.min||e.filter.active.max!==e.range.max};t.append("span").attr("class","base total").on("mousedown",function(){if(1===d3.event.which){e.owner.dom.intervalSlider.attr("anim",!1);var t=this.parentNode,s=e.owner.intervalScale.invert(d3.mouse(t)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var a=e.owner.intervalScale.invert(d3.mouse(t)[0]);e.filter.active.min=d3.min([s,a]),e.filter.active.max=d3.max([s,a]),e.owner.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){i()?(e.filter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:e.filter.id,info:e.filter.active.min+"x"+e.filter.active.m})):e.filter.clearFilter(!0)},200)}).on("mouseup",function(){e.owner.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}}),t.append("span").attr("class","base active").on("mousedown",function(){if(1===d3.event.which&&"time"!==e.owner.options.intervalScale){e.owner.dom.intervalSlider.attr("anim",!1);var t=this.parentNode,s=e.filter.active.min,a=e.filter.active.max,r=a-s,o=e.owner.intervalScale.invert(d3.mouse(t)[0]);d3.select("body").style("cursor","ew-resize").on("mousemove",function(){var n=e.owner.intervalScale.invert(d3.mouse(t)[0]),l=n-o;e.filter.active.min=s+l,e.filter.active.max=a+l,e.filter.active.min<e.range.min&&(e.filter.active.min=e.range.min,e.filter.active.max=e.range.min+r),e.filter.active.max>e.range.max&&(e.filter.active.max=e.range.max,e.filter.active.min=e.range.max-r),e.owner.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){i()?(e.filter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:e.filter.id,info:e.filter.active.min+"x"+e.filter.active.max})):e.filter.clearFilter(!0)},200)}).on("mouseup",function(){e.owner.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}});var s=function(t){if(1===d3.event.which){e.owner.dom.intervalSlider.attr("anim",!1);var s=this.parentNode;d3.select("body").style("cursor","ew-resize").on("mousemove",function(){e.owner.browser.pauseResultPreview=!0;var a=e.owner.intervalScale.invert(d3.mouse(s)[0]);if(e.filter.active[t]=a,e.filter.active.min>e.filter.active.max){var r=e.filter.active.min;e.filter.active.min=e.filter.active.max,e.filter.active.max=r,t="min"===t?"max":"min"}e.owner.refreshIntervalSlider(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){i()?(sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_HANDLE,{id:e.filter.id,info:e.filter.active.min+"x"+e.filter.active.max}),e.filter.addFilter(!0)):e.filter.clearFilter(!0)},200)}).on("mouseup",function(){e.owner.browser.pauseResultPreview=!1,e.owner.dom.intervalSlider.attr("anim",!0),d3.select("body").style("cursor","auto").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()}};t.selectAll("span.handle").data(["min","max"]).enter().append("span").attr("class",function(t){return"handle "+t}).on("mousedown",s).append("span").attr("class","invalidArea"),t.append("div").attr("class","selectedItemValue").append("div").attr("class","circlee")},setTransform:function(t,e){t.style.webkitTransform=e,t.style.MozTransform=e,t.style.msTransform=e,t.style.OTransform=e,t.style.transform=e}},Tipsy.prototype={defaults:{className:null,delayOut:0,fade:!1,fallback:"",gravity:"n",offset:0,offset_x:0,offset_y:0,opacity:.9},show:function(){var t=function(t,e){return"function"==typeof t?t.call(e):t},e=this.getTitle();if(e){var i=this.tip();i.find(".tipsy-inner").html(e),i[0].className="tipsy",i.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var s,a=$.extend({},this.jq_element.offset(),{width:this.jq_element[0].offsetWidth,height:this.jq_element[0].offsetHeight}),r=i[0].offsetWidth,o=i[0].offsetHeight,n=t(this.options.gravity,this.jq_element[0]);switch(n.charAt(0)){case"n":s={top:a.top+a.height+this.options.offset,left:a.left+a.width/2-r/2};break;case"s":s={top:a.top-o-this.options.offset,left:a.left+a.width/2-r/2};break;case"e":s={top:a.top+a.height/2-o/2,left:a.left-r-this.options.offset};break;case"w":s={top:a.top+a.height/2-o/2,left:a.left+a.width+this.options.offset}}s.top+=this.options.offset_y,s.left+=this.options.offset_x,2==n.length&&(s.left="w"==n.charAt(1)?a.left+a.width/2-15:a.left+a.width/2-r+15),i.css(s).addClass("tipsy-"+n),i.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+n.charAt(0),this.options.className&&i.addClass(t(this.options.className,this.jq_element[0])),this.options.fade?i.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity},200):i.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(200,function(){$(this).remove()}):this.tip().remove()},getTitle:function(){var t,t,e=this.jq_element,i=this.options,i=this.options;return"string"==typeof i.title?t=e.attr("title"==i.title?"original-title":i.title):"function"==typeof i.title&&(t=i.title.call(e[0])),t=(""+t).replace(/(^\s*|\s*$)/,""),t||i.fallback},tip:function(){return this.jq_tip?this.jq_tip:(this.jq_tip=$('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.jq_tip,this.jq_tip.data("tipsy-pointee",this.jq_element[0]),this.jq_tip)}},kshf.Item=function(t,e){this.data=t,this.idIndex=e,this.selected=1,this.items=[],this.itemCount_Active=0,this.itemCount_Preview=0,this.dirtyFilter=!0,this.filterCache=[],this.isWanted=!0,this.wantedOrder=0,this.mappedItems=[],this.mappedDataCache=[],this.selectedForLink=!1,this.resultDOM=void 0,this.facetDOM=void 0},kshf.Item.prototype={id:function(){return this.data[this.idIndex]},setFilter:function(t,e){this.filterCache[t]!==e&&(this.filterCache[t]=e,this.dirtyFilter=!0)},f_selected:function(){return 0!==this.selected},f_included:function(){return 1===this.selected},f_removed:function(){return-1===this.selected},f_unselect:function(){this.selected=0,this.facetDOM&&this.facetDOM.setAttribute("selected",this.selected)},f_include:function(){this.selected=1,this.facetDOM&&this.facetDOM.setAttribute("selected",this.selected)},f_remove:function(){this.selected=-1,this.facetDOM&&this.facetDOM.setAttribute("selected",this.selected)},addItem:function(t){this.items.push(t),this.itemCount_Active++,this.sortDirty=!0,t.mappedItems.push(this)},updateWanted:function(t){if(this.dirtyFilter){var e=this,i=this.isWanted;this.isWanted=!0,this.filterCache.every(function(t){return e.isWanted=e.isWanted&&t,e.isWanted}),this.isWanted===!0&&i===!1?this.mappedItems.forEach(function(e){e.itemCount_Active++,1===e.itemCount_Active&&void 0!==e.facet&&(t===e.facet||e.facet.isLinked||e.mappedDataCache.forEach(function(t){null!==t&&(t instanceof Array?t.forEach(function(t){t.itemCount_Active++}):t.b?t.b.itemCount_Active++:t.itemCount_Active++)})),e.sortDirty=!0}):this.isWanted===!1&&i===!0&&this.mappedItems.forEach(function(e){e.itemCount_Active--,0===e.itemCount_Active&&void 0!==e.facet&&(t===e.facet||e.facet.isLinked||e.mappedDataCache.forEach(function(t){null!==t&&(t instanceof Array?t.forEach(function(t){t.itemCount_Active--}):t.b?t.b.itemCount_Active--:t.itemCount_Active--)})),e.sortDirty=!0}),this.dirtyFilter=!1}},updateWanted_More:function(t){this.isWanted||this.updateWanted(t)},updateWanted_Less:function(t){this.isWanted&&this.updateWanted(t)},updatePreview:function(t){this.isWanted&&(this.resultDOM&&this.resultDOM.setAttribute("highlight",!0),this.facetDOM&&this.facet===t.parentFacet&&!this.facet.isLinked&&this.itemCount_Active>0&&this.items.forEach(function(t){t.updatePreview(this.facet)},this),this.mappedDataCache.forEach(function(e){null!==e&&(e instanceof Array?e.forEach(function(e){e.itemCount_Preview++,1===e.itemCount_Preview&&e.facet&&(e.facet.isLinked||e.facet===t||e.updatePreview(t))}):e.b?e.b.itemCount_Active>0&&e.b.itemCount_Preview++:void 0!==e.itemCount_Preview&&(e.itemCount_Preview++,e.facet&&!e.facet.isLinked&&1===e.itemCount_Preview&&e.facet!==t&&e.updatePreview(t)))}))},highlightAll:function(){this.resultDOM&&this.resultDOM.setAttribute("highlight",!0),this.facetDOM&&this.facetDOM.setAttribute("highlight",!0),this.mappedDataCache.forEach(function(t){null!==t&&(void 0!==t.h?t.h.setSelectedPosition(t.v):t instanceof Array?t.forEach(function(t){t.highlightAll()}):t.highlightAll())})},nohighlightAll:function(){this.resultDOM&&this.resultDOM.setAttribute("highlight",!1),this.facetDOM&&this.facetDOM.setAttribute("highlight",!1),this.mappedDataCache.forEach(function(t){null!==t&&(void 0!==t.h?t.h.hideSelectedPosition(t.v):t instanceof Array?t.forEach(function(t){t.nohighlightAll()}):t.nohighlightAll())})}},kshf.Filter=function(t,e){this.isFiltered=!1,this.filterSummaryBlock=null,this.name=e.name,this.browser=e.browser,this.filteredItems=e.filteredItems,this.onClear=e.onClear,this.onFilter=e.onFilter,this.hideCrumb=e.hideCrumb,this.text_header=e.text_header,this.text_item=e.text_item,this.facet=e.facet?e.facet:this,this.id=t,this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilter(this.id,!0)},this)},kshf.Filter.prototype={addFilter:function(t,e){var i=this.browser.itemsSelectedCt;this.isFiltered=!0,void 0===e&&(e=!0),this.onFilter&&this.onFilter.call(this.facet,this,e);var s=void 0!==this.facet.parentFacet;if(s){var a=this.facet.parentFacet;a.hasAttribs()&&(a.updateAttribCount_Wanted(),a.attribFilter.how="All",a.attribFilter.addFilter(!1,a))}this.refreshFilterSummary(),t===!0&&(this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),i!==this.browser.itemsSelectedCt&&this.browser.update(-1),sendLog&&sendLog(kshf.LOG.FILTER_ADD,this.browser.getFilteringState()))},clearFilter:function(t,e){if(this.isFiltered&&(this.browser.itemsSelectedCt,this.isFiltered=!1,this.filteredItems.forEach(function(t){t.setFilter(this.id,!0)},this),void 0===e&&(e=!0),this.onClear.call(this.facet,this),this.refreshFilterSummary(),this.filteredItems.forEach(function(t){t.updateWanted_More(e)}),t===!0)){if(this.facet.parentFacet){var i=this.facet.parentFacet;i.hasAttribs()&&(i.updateAttribCount_Wanted(),i.attribFilter.how="All",i.attribCount_Wanted===i.attribCount_Total?i.attribFilter.clearFilter(!1,i):i.attribFilter.addFilter(!1,i))}this.browser.updateItemSelectedCt(),this.browser.refreshFilterClearAll(),this.browser.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR,this.browser.getFilteringState())}},refreshFilterSummary:function(){if(void 0===this.hideCrumb&&this.browser.subBrowser!==!0&&this.browser.isSmallWidth()&&(this.hideCrumb=!0),this.hideCrumb!==!0)if(this.isFiltered){if(void 0!==this.facet.attribCount_Selected&&0===this.facet.attribCount_Selected)return;if(null===this.filterSummaryBlock&&(this.filterSummaryBlock=this.insertFilterSummaryBlock()),void 0!==this.text_header){var t=this.text_header;"function"==typeof t&&(t=t.call(this.facet,this)),this.browser.subBrowser===!0&&(t+=" ("+this.browser.itemName+")"),this.filterSummaryBlock.select(".txttt").html(t+": ")}if(void 0!==this.text_item){var t=this.text_item;"function"==typeof t&&(t=t.call(this.facet,this)),this.filterSummaryBlock.select(".filter_item").html(t)}}else{var e=this.filterSummaryBlock;if(null===e||void 0===e)return;e.attr("ready",!1),setTimeout(function(){e[0][0].parentNode.removeChild(e[0][0])},350),this.filterSummaryBlock=null}},insertFilterSummaryBlock:function(){var t,e=this;t=this.browser.dom.filtercrumbs.append("span").attr("class","filter-block"),t.append("span").attr("class","chartClearFilterButton summary").text("x").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'>x</span class='big'> <span class='action'>Remove</span> filter"}})}).on("click",function(){this.tipsy.hide(),e.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_CRUMB,{id:this.id})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide(),d3.event.stopPropagation()});var i=t.append("span").attr("class","sdsdsds");return i.append("span").attr("class","txttt"),i.append("span").attr("class","filter_item"),window.getComputedStyle(t[0][0]).opacity,t.attr("ready",!0),t}},kshf.List=function(t,e,i){var s=this;this.itemtoggledetailsWidth=20,this.browser=t,this.dom={},this.scrollTop_cache=0,this.linkColumnWidth=85,this.linkColumnWidth_ItemCount=25,this.linkColumnWidth_BarMax=this.linkColumnWidth-this.linkColumnWidth_ItemCount-3,this.selectColumnWidth=17,this.contentFunc=e.contentFunc,void 0!==e.content&&(this.contentFunc=this.browser.getColumnData(this.browser.primaryTableName,e.content)),this.maxVisibleItems=kshf.maxVisibleItems_default,e.maxVisibleItems_Default&&(this.maxVisibleItems=e.maxVisibleItems_Default),this.hasLinkedItems=!1,void 0!==e.hasLinkedItems&&(this.hasLinkedItems=!0),this.domStyle=e.domStyle,this.sortingOpts=e.sortingOpts,this.sortingOpts.forEach(function(t){void 0===t.value&&(t.value=this.browser.getColumnData(this.browser.primaryTableName,t.name)),t.label||(t.label=t.value),void 0===t.inverse&&(t.inverse=!1),void 0===t.func&&(t.func=s.getSortFunc(t.value))},this),this.sortingOpt_Active=this.sortingOpts[0],this.displayType="list","grid"===e.displayType&&(this.displayType="grid"),this.visibleCb=e.visibleCb,this.detailCb=e.detailCb,this.sortColWidth=e.sortColWidth,this.textSearch=e.textSearch,this.textSearchFunc=e.textSearchFunc,void 0!==this.textSearch&&(void 0===this.textSearchFunc&&(this.textSearchFunc=this.browser.getColumnData(this.browser.primaryTableName,this.textSearch)),"*"===this.textSearch[0]&&(this.textSearch=this.textSearch.substring(1)),this.textSearch=kshf.Util.toProperCase(this.textSearch)),this.hideTextSearch=void 0===this.textSearchFunc,this.detailsToggle=e.detailsToggle,void 0===this.detailsToggle&&(this.detailsToggle="Off"),this.detailsDefault=e.detailsDefault,void 0===this.detailsDefault&&(this.detailsDefault=!1),"One"===this.detailsToggle&&(this.detailsDefault=!1),this.listDiv=i.select("div.listDiv").attr("showAll",this.detailsDefault?"false":"true").attr("detailsToggle",this.detailsToggle),this.dom.listHeader=this.listDiv.append("div").attr("class","listHeader"),this.dom.listHeader_TopRow=this.dom.listHeader.append("div").attr("class","topRow"),this.dom.listHeader_BottomRow=this.dom.listHeader.append("div").attr("class","bottomRow"),this.dom.listItemGroup=this.listDiv.append("div").attr("class","listItemGroup").on("scroll",function(){this.scrollHeight-this.scrollTop-this.offsetHeight<10?s.dom.showMore.style("bottom","4px"):s.dom.showMore.style("bottom","-27px"),s.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden")}),this.sortFilters=[],"list"===this.displayType&&this.sortingOpts.forEach(function(e){this.sortFilters.push(t.createFilter({name:e.name,browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(t){t.filterValue=""},onFilter:function(t,e){var i=this.sortingOpt_Active.label;t.filteredItems.forEach(function(s){s.setFilter(t.id,i(s)===t.filterValue),s.updateWanted(e)})},text_header:e.name,text_item:function(t){return"<b>"+t.filterValue+"</b>"}}))},this),this.sortFilter_Active=this.sortFilters[0],this.dom.scrollToTop=this.dom.listHeader_BottomRow.append("div").attr("class","scrollToTop").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(s.dom.listItemGroup[0][0],0),sendLog&&sendLog(kshf.LOG.LIST_SCROLL_TOP)}),this.insertHeaderSortSelect(),"Off"!==this.detailsToggle&&this.insertHeaderToggleDetails(),this.hasLinkedItems&&this.insertHeaderLinkedItems(),this.sortItems(),this.insertItems(),this.dom.showMore=this.listDiv.append("div").attr("class","showMore").on("click",function(){s.maxVisibleItems*=2,s.updateItemVisibility(!0),this.style.bottom="-25px",sendLog&&sendLog(kshf.LOG.LIST_SHOWMORE,{info:s.maxVisibleItems})}).on("mouseenter",function(){d3.select(this).selectAll(".loading_dots").attr("anim",!0)}).on("mouseleave",function(){d3.select(this).selectAll(".loading_dots").attr("anim",null)}),this.dom.showMore.append("span").attr("class","MoreText").html("Show More"),this.dom.showMore.append("span").attr("class","Count CountAbove"),this.dom.showMore.append("span").attr("class","Count CountBelow"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_1"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_2"),this.dom.showMore.append("span").attr("class","loading_dots loading_dots_3")},kshf.List.prototype={insertHeaderTextSearch:function(){var t,e=this;this.textFilter=this.browser.createFilter({name:"TextSearch",browser:this.browser,filteredItems:this.browser.items,facet:this,onClear:function(e){e.filterStr="",this.dom.mainTextSearch[0][0].value="",t.select(".clearText").style("display","none")},onFilter:function(i,s){i.filterStr=i.filterStr.split(" "),t.select(".clearText").style("display","inline-block"),i.filteredItems.forEach(function(t){var a=!i.filterStr.every(function(i){return-1===e.textSearchFunc(t).toLowerCase().indexOf(i)});t.setFilter(i.id,a),t.updateWanted(s)})},hideCrumb:!0}),t=this.dom.listHeader_TopRow.append("span").attr("class","mainTextSearch"),t.append("i").attr("class","fa fa-search searchIcon"),this.dom.mainTextSearch=t.append("input").attr("placeholder","Search "+(this.textSearch?this.textSearch:"title")).attr("autofocus","true").on("keydown",function(){var t=this;this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){e.textFilter.filterStr=t.value.toLowerCase(),""!==e.textFilter.filterStr?e.textFilter.addFilter(!0):e.textFilter.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:e.textFilter.id,info:e.textFilter.filterStr}),t.timer=null},750)}),t.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){e.textFilter.clearFilter(!0)})},insertHeaderSortSelect:function(){var t=this,e=this.dom.listHeader_BottomRow.append("div").attr("class","listsortcolumn").style("width",this.sortColWidth+"px").style("white-space","nowrap");return"grid"===t.displayType&&e.append("span").attr("class","sortBy").text("Sort by: "),1===this.sortingOpts.length?(e.append("span").text(this.sortingOpts[0].name),void 0):(e.append("select").attr("class","listSortOptionSelect").style("width",this.sortColWidth+"px").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.sortFilter_Active=t.sortFilters[this.selectedIndex],t.reorderItemsOnDOM(),t.updateVisibleIndex(),t.maxVisibleItems=kshf.maxVisibleItems_default,t.updateItemVisibility(),"list"===t.displayType&&t.dom.listsortcolumn.html(function(e){return t.sortingOpt_Active.label(e)}).each(function(e){this.columnValue=t.sortingOpt_Active.label(e)}),sendLog&&sendLog(kshf.LOG.LIST_SORT,{info:this.selectedIndex})}).selectAll("input.list_sort_label").data(this.sortingOpts).enter().append("option").attr("class","list_sort_label").text(function(t){return t.name}),void 0)},insertHeaderToggleDetails:function(){var t=this,e=this.dom.listHeader_BottomRow.append("div").attr("class","itemtoggledetails");e.append("span").attr("class","items_details_on").html("[+]").attr("title","Show details").on("click",function(){t.dom.listItems.attr("details",!0),t.listDiv.attr("showAll","false")}),e.append("span").attr("class","items_details_off").html("[-]").attr("title","Hide details").on("click",function(){t.dom.listItems.attr("details",!1),t.listDiv.attr("showAll","true")})},insertHeaderLinkedItems:function(){var t=this,e=this.dom.listHeader_BottomRow.append("span").attr("class","selectColumn");e.append("span").attr("class","selectSelect").text("Select:"),e.append("i").attr("class","fa fa-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'>-</span class='big'> <span class='action'>Unselect</span> all results"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.browser.items.forEach(function(t){t.isWanted&&(t.selectedForLink=!1,t.resultDOM.setAttribute("selectLinked",!1))}),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()}),e.append("i").attr("class","fa fa-check-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'>+</span class='big'> <span class='action'>Select</span> all results"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.browser.items.forEach(function(t){t.isWanted&&(t.selectedForLink=!0,t.resultDOM.setAttribute("selectLinked",!0))}),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()})},insertItems:function(){var t=this;if(this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).enter().append("div").attr("class",function(e){var i="listItem";return t.domStyle&&(i+=" "+t.domStyle.call(this,e)),i}).attr("details",this.detailsDefault?"true":"false").attr("highlight",!1).attr("animSt","visible").attr("selectLinked","false").attr("itemID",function(t){return t.id()}).each(function(t){t.resultDOM=this}).on("mouseover",function(t){d3.select(this).attr("highlight","true"),t.highlightAll()}).on("mouseout",function(t){d3.select(this).attr("highlight","false"),t.nohighlightAll(!0)}),"list"===this.displayType&&this.insertItemSortColumn(),"Off"!==this.detailsToggle&&this.insertItemToggleDetails(),this.dom.listItems_Content=this.dom.listItems.append("div").attr("class","content").html(function(e){return t.contentFunc(e)}),this.hasLinkedItems){var e=this.dom.listItems.append("span").attr("class","selectColumn").style("width",this.selectColumnWidth+"px");e.append("i").attr("class","fa fa-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'></span class='big'> <span class='action'>Select</span> item"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(e){this.tipsy.hide(),e.selectedForLink=!0,this.parentNode.parentNode.setAttribute("selectLinked",!0),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()}),e.append("i").attr("class","fa fa-check-square-o").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'>-</span class='big'> <span class='action'>Unselect</span> item"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(e){this.tipsy.hide(),e.selectedForLink=!1,this.parentNode.parentNode.setAttribute("selectLinked",!1),t.browser.linkedFacets.forEach(function(t){t.updateSorting(0)}),t.browser.updateLayout_Height()})}},insertItemSortColumn:function(){var t=this;this.dom.listsortcolumn=this.dom.listItems.append("div").attr("class","listcell listsortcolumn").style("width",this.sortColWidth+"px").html(function(e){return t.sortingOpt_Active.label(e)}).each(function(e){this.columnValue=t.sortingOpt_Active.label(e)}).each(function(){this.tipsy=new Tipsy(this,{gravity:"s",fade:!0,opacity:1,title:function(){return"<span class='big'>+</span> <span class='action'>Add</span> <i>"+t.sortingOpt_Active.name+"</i> Filter"}})}).on("mouseover",function(){t.sortFilter_Active.isFiltered||this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.sortFilter_Active.isFiltered||(this.tipsy.hide(),t.sortFilter_Active.filterValue=this.columnValue,t.sortFilter_Active.addFilter(!0))})},insertItemToggleDetails:function(){var t=this,e=this.dom.listItems.append("div").attr("class","listcell itemtoggledetails").each(function(){this.tipsy=new Tipsy(this,{gravity:"s",fade:!0,className:"details",title:function(){return"Show details"}})});e.append("span").attr("class","item_details_on").html("[+]").on("click",function(e){this.parentNode.tipsy.hide(),t.showListItemDetails(e)}).on("mouseover",function(){this.parentNode.tipsy.options.title=function(){return"Show details"},this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()}),e.append("span").attr("class","item_details_off").html("[-]").on("click",function(e){t.hideListItemDetails(e)}).on("mouseover",function(){this.parentNode.tipsy.options.title=function(){return"Hide details"},this.parentNode.tipsy.show()}).on("mouseout",function(){this.parentNode.tipsy.hide()})},hideListItemDetails:function(t){t.resultDOM.setAttribute("details",!1),this.lastSelectedItem=void 0,sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_OFF,{info:t.id()})},showListItemDetails:function(t){t.resultDOM.setAttribute("details",!0),"One"===this.detailsToggle&&this.lastSelectedItem&&this.lastSelectedItem.resultDOM.setAttribute("details",!1),this.detailCb&&this.detailCb.call(this,t),this.lastSelectedItem=t,sendLog&&sendLog(kshf.LOG.ITEM_DETAIL_ON,{info:t.id()})},updateShowListGroupBorder:function(){if("list"===this.displayType)if(this.sortingOpt_Active.noGroupBorder===!0)this.dom.listItems.style("border-top-width","0px");else{var t=null,e=this.sortingOpt_Active.value,i=this.sortingOpt_Active.func;this.browser.items.forEach(function(s){s.isWanted&&(null!==t&&void 0!==s.resultDOM&&(s.resultDOM.style.borderTopWidth=0!==i(e(s),e(t))?"4px":"0px"),t=s)})}},reorderItemsOnDOM:function(){this.sortItems(),this.dom.listItems=this.dom.listItemGroup.selectAll("div.listItem").data(this.browser.items,function(t){return t.id()}).order()},sortItems:function(){var t=this.sortingOpt_Active.value,e=this.sortingOpt_Active.func,i=this.sortingOpt_Active.inverse;this.browser.items.sort(function(s,a){var r=t(s),o=t(a);if(void 0===r&&void 0!==o)return 1;if(void 0===o&&void 0!==r)return-1;if(void 0===o&&void 0===r)return 0;var n=e(r,o);return 0===n&&(n=a.id()-s.id()),i?-n:n})},getSortFunc:function(t){for(var e,i,s,a=0,s=0;!0;a++){if(3===s||a===this.browser.items.length){e=i;break}var r,o=this.browser.items[a],n=t(o);switch(typeof n){case"string":r=kshf.Util.sortFunc_List_String;break;case"number":r=kshf.Util.sortFunc_List_Number;break;case"object":r=n instanceof Date?kshf.Util.sortFunc_List_Date:kshf.Util.sortFunc_List_Number;break;default:r=kshf.Util.sortFunc_List_Number}r===i?s++:(i=r,s=0)}return e},updateItemVisibility:function(t){var e=this,i="list"===this.displayType?"block":"inline-block",s=0;this.dom.listItems.each(function(a){var r=this,o=a.wantedOrder>=0&&a.wantedOrder<e.maxVisibleItems;if(o&&s++,o&&e.visibleCb&&e.visibleCb.call(this,a),t)return this.style.display=o?i:"none",this.setAttribute("animSt","visible"),void 0;var n=a.wantedOrder>=0&&a.wantedOrder<50,l=a.wantedOrder_pre>=0&&a.wantedOrder_pre<50;n?l?(this.setAttribute("animSt","visible"),this.style.display=o?i:"none"):(this.style.display=i,r.setAttribute("animSt","closed"),setTimeout(function(){r.setAttribute("animSt","open")},500),setTimeout(function(){r.setAttribute("animSt","visible")},1100+10*a.wantedOrder)):l&&o===!1?(setTimeout(function(){r.setAttribute("animSt","open")},10*-a.wantedOrder),setTimeout(function(){r.setAttribute("animSt","closed")},500),setTimeout(function(){r.style.display="none"},1e3)):(this.setAttribute("animSt","visible"),this.style.display=o?i:"none")});var a=this.browser.itemsSelectedCt-s;
this.dom.showMore.style("display",0===a?"none":"block"),this.dom.showMore.select(".CountAbove").html("&#x25B2;"+s+" shown"),this.dom.showMore.select(".CountBelow").html(a+" below&#x25BC;")},updateContentWidth:function(t){t-=4,t-=this.browser.scrollWidth,this.dom.showMore.style("width",t-5+"px"),t-=this.sortColWidth,"Off"!==this.detailsToggle&&(t-=this.itemtoggledetailsWidth),this.hasLinkedItems&&(t-=this.selectColumnWidth),"list"===this.displayType&&this.dom.listItems_Content.style("width",t+"px"),this.hasLinkedItems&&(t-=75),this.browser.dom.filtercrumbs.style("width",t-15+"px")},updateAfterFiltering_do:function(){this.updateVisibleIndex(),this.maxVisibleItems=kshf.maxVisibleItems_default,this.updateItemVisibility(!1)},updateAfterFiltering:function(){var t=this,e=null,i=this.dom.listItemGroup[0][0],s=i.scrollTop,a=d3.ease("cubic-in-out"),r=1e3,o=function(n){var l;null===e&&(e=n),l=(n-e)/r,i.scrollTop=(1-a(l))*s,0===i.scrollTop?t.updateAfterFiltering_do():window.requestAnimationFrame(o)};window.requestAnimationFrame(o)},updateVisibleIndex:function(){var t=0,e=1;this.browser.items.forEach(function(i){i.wantedOrder_pre=i.wantedOrder,i.isWanted?(i.wantedOrder=t,t++):(i.wantedOrder=-e,e++)},this)}},kshf.Browser=function(t){var e=this;this.facets=[],this.facetsTop=[],this.facetsBottom=[],this.facetsLeft=[],this.facetsRight=[],this.linkedFacets=[],this.maxFilterID=0,this.barChartWidth=0,this.scrollWidth=21,this.sepWidth=10,this.line_height=18,this.filterList=[],this.pauseResultPreview=!1,this.columnsSkip=t.columnsSkip,this.categoryTextWidth=t.categoryTextWidth,void 0===this.categoryTextWidth&&(this.categoryTextWidth=115),"number"==typeof t.barChartWidth&&(this.barChartWidthInit=t.barChartWidth),this.subBrowser=t.subBrowser,this.facetDefs=t.facets,t.charts&&(this.facetDefs=t.charts),this.listDef=t.itemDisplay,t.list&&(this.listDef=t.list),this.listMaxColWidthMult=t.listMaxColWidthMult?t.listMaxColWidthMult:.25,this.domID=t.domID,this.source=t.source,this.source.loadedTableCount=0,this.loadedCb=t.loadedCb,this.readyCb=t.readyCb,this.updateCb=t.updateCb,this.dom={},this.itemName=void 0!==t.itemName?t.itemName:this.source.sheets[0].name,this.primItemCatValue=null,"string"==typeof t.catValue&&(this.primItemCatValue=t.catValue),this.showDataSource=!0,void 0!==t.showDataSource&&(this.showDataSource=t.showDataSource),this.forceHideBarAxis=!1,void 0!==t.forceHideBarAxis&&(this.forceHideBarAxis=t.forceHideBarAxis),this.TopRoot=d3.select(this.domID).classed("kshfHost",!0).style("position","relative").style("overflow-y","hidden");for(var i=this.TopRoot[0][0];i.hasChildNodes();)i.removeChild(i.lastChild);this.root=this.TopRoot.attr("noanim",!1),t.showResizeCorner===!0&&this.insertResize(),this.insertInfobox(),this.dom.subRoot=this.root.append("div").attr("class","subRoot"),this.layoutTop=this.dom.subRoot.append("div").attr("class","kshf layout_top"),this.layoutLeft=this.dom.subRoot.append("div").attr("class","kshf layout_left"),this.layoutRight=this.dom.subRoot.append("div").attr("class","kshf layout_right"),this.layoutList=this.dom.subRoot.append("div").attr("class","kshf listDiv"),this.layoutBottom=this.dom.subRoot.append("div").attr("class","kshf layout_bottom"),this.facetBackground=this.layoutLeft.append("div").attr("class","kshf layout_left_background"),this.dom.leftBlockAdjustSize=this.facetBackground.append("div").style("position","relative").style("height","100%").append("span").attr("class","leftBlockAdjustSize").attr("title","Drag to adjust panel width").on("mousedown",function(){if(1===d3.event.which){e.root.style("cursor","ew-resize"),e.root.attr("noanim",!0);var t=d3.mouse(this.parentNode.parentNode)[0],i=e.barChartWidth;e.root.on("mousemove",function(){var s=d3.mouse(this)[0],a=s-t,r=e.hideBarAxis;e.setBarWidthLeftPanel(i+a),e.hideBarAxis!==r&&e.updateLayout_Height()}).on("mouseup",function(){e.root.style("cursor","default"),e.root.attr("noanim",!1),e.root.on("mousemove",null).on("mouseup",null),sendLog&&sendLog(kshf.LOG.BARCHARTWIDTH,{info:e.barChartWidth})}),d3.event.preventDefault()}}).on("click",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),this.loadSource()},kshf.Browser.prototype={getRowTotalTextWidth:function(){return this.categoryTextWidth+this.getRowLabelOffset()},getWidth_LeftPanel:function(){return this.getRowTotalTextWidth()+this.barChartWidth+this.scrollWidth},getWidth_Total:function(){return this.divWidth},domHeight:function(){return parseInt(this.TopRoot.style("height"))},domWidth:function(){return parseInt(this.TopRoot.style("width"))},createFilter:function(t){var e=new kshf.Filter(this.maxFilterID,t);return++this.maxFilterID,this.filterList.push(e),e},insertResize:function(){var t=this;this.root.append("div").attr("class","kshf layout_resize").on("mousedown",function(){t.root.style("cursor","nwse-resize"),t.root.attr("noanim",!0);var e=d3.mouse(d3.select("body")[0][0])[0],i=d3.mouse(d3.select("body")[0][0])[1],s=parseInt(d3.select(this.parentNode).style("width")),a=parseInt(d3.select(this.parentNode).style("height"));d3.select("body").on("mousemove",function(){var r=d3.mouse(d3.select("body")[0][0])[0]-e,o=d3.mouse(d3.select("body")[0][0])[1]-i;d3.select(t.domID).style("height",a+o+"px"),d3.select(t.domID).style("width",s+r+"px"),t.updateLayout()}).on("mouseup",function(){sendLog&&sendLog(kshf.LOG.RESIZE),t.root.style("cursor","default"),t.root.attr("noanim",!1),d3.select("body").on("mousemove",null).on("mouseup",null)}),d3.event.preventDefault()})},insertInfobox:function(){var t=this,e="";e+="<div align='center'>",e+="<div class='header'>This data browser is created by <span class='libName'>Keshif</span>.</div>",e+="<div align='center' class='boxinbox project_credits'>",e+="<div>Developed by</div>",e+=" <a href='http://www.cs.umd.edu/hcil/' target='_blank'><img src='https://wiki.umiacs.umd.edu/hcil/images/1/10/HCIL_logo_small_no_border.gif' style='height:50px'></a>",e+=" <a class='myName' href='http://www.adilyalcin.me' target='_blank'>M. Adil Yalçın</a>",e+=" <a href='http://www.umd.edu' target='_blank'><img src='http://www.trademarks.umd.edu/marks/gr/informal.gif' style='height:50px'></a>",e+="</div>",e+="",e+="<div align='center' class='boxinbox project_credits'>",e+="<div style='float:right; text-align: right'>",e+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=watch&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe><br/>",e+="</div>",e+="<div style='float:left; padding-left: 10px'>",e+="<iframe src='http://ghbtns.com/github-btn.html?user=adilyalcin&repo=Keshif&type=fork&count=true' allowtransparency='true' frameborder='0' scrolling='0' width='90px' height='20px'></iframe>",e+="</div>",e+=" 3rd party libraries and APIs:<br/>",e+=" <a href='http://d3js.org/' target='_blank'>D3</a> -",e+=" <a href='http://jquery.com' target='_blank'>JQuery</a> -",e+=" <a href='https://developers.google.com/chart/' target='_blank'>GoogleDocs</a>",e+="</div><br/>",e+="",e+="<div align='center' class='project_fund'>",e+="Keshif (<a target='_blank' href='http://translate.google.com/#auto/en/ke%C5%9Fif'><i>keşif</i></a>) means discovery / exploration in Turkish.<br/>",e+="Funded in part by <a href='http://www.huawei.com'>Huawei</a>. </div>",e+="",this.layout_infobox=this.root.append("div").attr("class","kshf layout_infobox"),this.layout_infobox.append("div").attr("class","infobox_background").on("click",function(){t.layout_infobox.style("display","none"),t.layout_infobox.select("div.infobox_credit").style("display","none"),t.layout_infobox.select("div.infobox_datasource").style("display","none")}),this.dom.loadingBox=this.layout_infobox.append("div").attr("class","infobox_content infobox_loading");var i=this.dom.loadingBox.append("span").attr("class","loadinggg");i.append("span").attr("class","loading_dots loading_dots_1").attr("anim",!0),i.append("span").attr("class","loading_dots loading_dots_2").attr("anim",!0),i.append("span").attr("class","loading_dots loading_dots_3").attr("anim",!0);var s=this.dom.loadingBox.append("div").attr("class","status_text");s.append("span").attr("class","info").text("Loading data sources..."),s.append("span").attr("class","dynamic").text(void 0!==this.source.sheets?"("+this.source.loadedTableCount+"/"+this.source.sheets.length+")":"");var a=this.layout_infobox.append("div").attr("class","infobox_content infobox_credit");a.append("div").attr("class","infobox_close_button").text("x").on("click",function(){t.layout_infobox.style("display","none"),t.layout_infobox.select("div.infobox_credit").style("display","none"),t.layout_infobox.select("div.infobox_datasource").style("display","none")}),a.append("div").attr("class","all-the-credits").html(e);var r=this.layout_infobox.append("div").attr("class","infobox_content infobox_datasource").text("Datasource files:");r.append("div").attr("class","infobox_close_button").text("x").on("click",function(){t.layout_infobox.style("display","none"),t.layout_infobox.select("div.infobox_credit").style("display","none"),t.layout_infobox.select("div.infobox_datasource").style("display","none")});var o=r.append("ul");this.showDataSource&&void 0===this.source.gDocId&&void 0===this.source.callback&&o.selectAll("li").data(this.source.sheets,this._dataMap).enter().append("li").append("a").attr("target","_blank").attr("href",function(e){return t.source.dirPath+e.name+"."+t.source.fileType}).text(function(e){return e.name+"."+t.source.fileType})},insertClearAll:function(){var t=this;return void 0===this.listDisplay?(this.dom.filterClearAll=this.root.select(".ffffffff"),void 0):(this.dom.filterClearAll=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","filterClearAll").text("Clear all").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,opacity:1,title:function(){return"<span class='big'>x</span class='big'> <span class='action'>Remove</span> all filtering"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide(),d3.event.stopPropagation()}).on("click",function(){this.tipsy.hide(),t.clearFilters_All()}),this.dom.filterClearAll.append("div").attr("class","chartClearFilterButton allFilter").text("x"),void 0)},showInfoBox:function(){this.layout_infobox.style("display","block"),this.layout_infobox.select(".infobox_credit").style("display","block"),sendLog&&sendLog(kshf.LOG.INFOBOX)},loadSource:function(){this.source.sheets&&(this.source.sheets[0].primary=!0,this.primaryTableName=this.source.sheets[0].name,this.source.sheets.forEach(function(t){return void 0===t.id&&(t.id="id"),void 0===t.tableName&&(t.tableName=t.name),void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.source.gdocId?(this.source.url="https://docs.google.com/spreadsheet/ccc?key="+this.source.gdocId,this.loadSheet_Google(t)):this.source.dirPath?this.loadSheet_File(t):t.data&&this.loadSheet_Memory(t),void 0)},this)),this.source.callback&&this.source.callback(this)},loadSheet_Google:function(t){var e=this,i=kshf.queryURL_base+this.source.gdocId+"&headers=1";i+=t.sheetID?"&gid="+t.sheetID:"&sheet="+t.name,t.range&&(i+="&range="+t.range);var s=new google.visualization.Query(i);t.query&&s.setQuery(t.query),s.send(function(i){if(void 0!==kshf.dt[t.tableName])return e.incrementLoadedSheetCount(),void 0;if(i.isError())return e.layout_infobox.select("div.status_text .info").text("Cannot load data"),e.layout_infobox.select("span.loadinggg").selectAll("span").remove(),e.layout_infobox.select("span.loadinggg").append("i").attr("class","fa fa-warning"),e.layout_infobox.select("div.status_text .dynamic").text("("+i.getMessage()+")"),void 0;var s,a,r,o=[],n=-1,l=0,h=i.getDataTable(),c=h.getNumberOfColumns();for(r=0;!0;r++)if(r===c||h.getColumnLabel(r).trim()===t.id){n=r;break}for(o.length=h.getNumberOfRows(),a=0;a<h.getNumberOfRows();a++){var d=[];for(d.length=c,r=0;c>r;r++)d[r]=h.getValue(a,r);n===c&&d.push(l++),o[a]=new kshf.Item(d,n)}for(kshf.createColumnNames(t.tableName),s=0;s<h.getNumberOfColumns();s++)kshf.insertColumnName(t.tableName,h.getColumnLabel(s).trim(),s);e.finishDataLoad(t,o)})},loadSheet_File:function(t){var e=this,i=this.source.dirPath+t.name+"."+this.source.fileType;$.ajax({url:i,type:"GET",async:void 0===e.source.callback?!0:!1,contentType:"text/csv",success:function(i){if(void 0!==kshf.dt[t.tableName])return e.incrementLoadedSheetCount(),void 0;var s=[],a=t.id,r=void 0===a,o={};o.dynamicTyping=!0,o.header=!0,t.header===!1&&(o.header=!1),t.preview&&(o.preview=t.preview);var n=Papa.parse(i,o);n.data.forEach(function(t,e){r&&t.push(e),s.push(new kshf.Item(t,a))}),e.finishDataLoad(t,s)}})},loadSheet_Memory:function(t){var e,i=[],s=-1,a=0;return void 0!==kshf.dt[t.tableName]?(this.incrementLoadedSheetCount(),void 0):(this.createColumnNames(t.tableName),t.data.forEach(function(r,o){0===o?(r.forEach(function(e,i){kshf.insertColumnName(t.tableName,e,i),e===t.id&&(s=i)}),-1===s&&(kshf.insertColumnName(t.tableName,t.id,e),s=e)):(s===r.length&&r.push(a++),i.push(new kshf.Item(r,s)))}),this.finishDataLoad(t,i),void 0)},createTableFromTable:function(t,e,i,s){var a=0;kshf.dt_id[e]={},kshf.dt[e]=[];var r=kshf.dt_id[e],o=kshf.dt[e];t.forEach(function(t){var e=i(t);if(""!==e&&void 0!==e&&null!==e)if(e instanceof Array)e.forEach(function(t){if(""!==t&&void 0!==t&&null!==t&&!r[t]){var e=[a++,t];s&&e.push(s(t));var i=new kshf.Item(e,0);r[t]=i,o.push(i)}});else if(!r[e]){var n=[a++,e];s&&n.push(s(v2));var l=new kshf.Item(n,0);r[e]=l,o.push(l)}})},finishDataLoad:function(t,e){kshf.dt[t.tableName]=e;var i={};e.forEach(function(t){i[t.id()]=t}),kshf.dt_id[t.tableName]=i,this.incrementLoadedSheetCount()},incrementLoadedSheetCount:function(){var t=this;this.source.loadedTableCount++,this.layout_infobox.select("div.status_text .dynamic").text("("+this.source.loadedTableCount+"/"+this.source.sheets.length+")"),void 0===this.source.callback&&this.source.loadedTableCount===this.source.sheets.length&&(this.source.sheets.forEach(function(t){t.primary&&(this.items=kshf.dt[t.tableName],this.itemsSelectedCt=this.items.length)},this),this.layout_infobox.select("div.status_text .info").text("Creating browser..."),this.layout_infobox.select("div.status_text .dynamic").text(""),window.setTimeout(function(){t.loadCharts()},50))},loadCharts:function(){var t=this;if(void 0!==this.loadedCb&&this.loadedCb.call(this),void 0===this.facetDefs){this.facetDefs=[];var e={};this.columnsSkip&&this.columnsSkip.forEach(function(t){e[t]=!0},this);var i=kshf.dt_ColNames_Arr[this.primaryTableName];i.forEach(function(t){t!==this.source.sheets[0].id&&e[t]!==!0&&"*"!==t[0]&&this.facetDefs.push({facetTitle:t})},this)}if(this.facetDefs.forEach(function(e){t.addFacet(e,this.primaryTableName)},this),this.facets.forEach(function(t){t.init_DOM()}),void 0!==this.listDef){this.listDisplay=new kshf.List(this,this.listDef,this.dom.subRoot);var s=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","resultInfo"),a=this.listDisplay.sortColWidth+5;"Off"!==this.listDisplay.detailsToggle&&(a+=15),this.dom.listheader_count=s.append("span").attr("class","listheader_count").style("width",a+"px"),s.append("span").attr("class","listheader_itemName").html(this.itemName),this.listDisplay.hideTextSearch!==!0&&this.listDisplay.insertHeaderTextSearch(),this.dom.filtercrumbs=this.listDisplay.dom.listHeader_BottomRow.append("span").attr("class","filtercrumbs");var r=this.listDisplay.dom.listHeader_TopRow.append("span").attr("class","rightBoxes");if(this.showDataSource!==!1){var o=null;this.source.url?o=r.append("a").attr("class","fa fa-table datasource").attr("href",this.source.url).attr("target","_blank"):this.source.dirPath&&(o=r.append("i").attr("class","fa fa-table datasource")),o&&o.each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,title:function(){return"Open Data Source"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){sendLog&&sendLog(kshf.LOG.DATASOURCE)})}r.append("i").attr("class","fa fa-info-circle credits").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,title:function(){return"Show Info & Credits"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){t.showInfoBox()})}this.insertClearAll(),this.loaded=!0,this.initBarChartWidth(),this.refreshFilterClearAll(),this.update(0,!0),this.updateLayout_Height(),this.layout_infobox.style("display","none"),this.dom.loadingBox.style("display","none"),void 0!==this.readyCb&&this.readyCb(this)},addFacet:function(t,e){if(t.catTableName===this.primaryTableName&&(this.listDef.hasLinkedItems=!0),void 0===t.catItemMap)if(void 0!==kshf.dt_ColNames[e]){var i=this.getColumnID(e,t.facetTitle);void 0!==i&&(t.catItemMap=function(t){return t.data[i]})}else kshf.dt[e][0].data[t.facetTitle]&&(t.catItemMap=function(e){return e.data[t.facetTitle]});else"string"==typeof t.catItemMap&&(t.catItemMap=this.getColumnData(e,t.catItemMap));if(t.timeTitle&&(void 0===t.timeItemMap?t.timeItemMap=this.getColumnData(e,t.timeTitle):"string"==typeof t.timeItemMap&&(t.timeItemMap=this.getColumnData(e,t.timeItemMap))),void 0===t.items&&(t.items=this.items),t.type)t.type=t.type.toLowerCase();else if(t.catLabelText||t.timeTitle||t.catTableName)t.type="categorical";else if(t.intervalScale)t.type="interval";else if(void 0!==t.catItemMap){var s=t.catItemMap(kshf.dt[e][0]);t.type="number"==typeof s||s instanceof Date?"interval":"categorical"}else t.type="categorical";var a;switch("categorical"===t.type?(void 0!==t.timeTitle&&(t.layout="top"),a=this.addFacet_Categorical(t)):"interval"===t.type&&(a=this.addFacet_Interval(t)),t.layout){case"left":this.facetsLeft.push(a);break;case"right":this.facetsRight.push(a);break;case"top":this.facetsTop.push(a);break;case"bottom":this.facetsBottom.push(a);break;case"bottomleft":this.facetsLeft.push(a),this.facetsBottom.push(a)}return a},addFacet_Categorical:function(t){void 0===t.layout&&(t.layout="left"),void 0===t.sortingOpts&&(t.sortingOpts=[{}]);var e=new kshf.Facet_Categorical(this,t);return this.facets.push(e),e.isLinked&&this.linkedFacets.push(e),e},addFacet_Interval:function(t){void 0===t.layout&&(t.layout="left");var e=new kshf.Facet_Interval(this,t);return this.facets.push(e),e},getColumnID:function(t,e){return void 0===kshf.dt_ColNames[t]?void 0:kshf.dt_ColNames[t][e]},getColumnData:function(t,e){var i=this.getColumnID(t,e);return void 0===i?function(t){return t.data[e]}:function(t){return t.data[i]}},mapItemData:function(t,e,i,s){t.forEach(function(t){var a=e(t);if(t.mappedDataCache[s]=null,void 0!==a&&""!==a&&null!==a){if(a instanceof Array){var r={};if(a=a.filter(function(t){return void 0===t||""===t||null===t?!1:void 0===r[t]?(r[t]=!0,!0):!1}),0===a.length)return;if(1!==a.length)return t.mappedDataCache[s]=[],a.forEach(function(e){var a=i[e];void 0!=a&&(t.mappedDataCache[s].push(a),a.addItem(t))}),void 0;a=a[0]}var o=i[a];void 0!=o&&(t.mappedDataCache[s]=o,o.addItem(t))}})},getRowLabelOffset:function(){if(this._labelXOffset)return this._labelXOffset;var t=d3.max(this.facets,function(t){return t.getMaxBarValueMaxPerAttrib()});this._labelXOffset=13;for(var e=1;t>9;)e++,t=Math.floor(t/10);return e>4&&(e=4),this._labelXOffset+=6*e,this._labelXOffset},filterFacetAttribute:function(t,e){this.facets[t].filterAttrib(this.facets[t].getAttribs()[e],!0)},clearFilters_All:function(t){var e=this;this.filterList.forEach(function(t){t.clearFilter(!1)}),t!==!1&&(this.items.forEach(function(t){t.updateWanted_More(!0)}),this.updateItemSelectedCt(),this.refreshFilterClearAll(),this.update(1),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_ALL)),setTimeout(function(){e.updateLayout_Height()},1e3)},updateItemSelectedCt:function(){this.itemsSelectedCt=0,this.items.forEach(function(t){t.isWanted&&this.itemsSelectedCt++},this)},update:function(t){void 0===this.firsttimeupdate&&(this.items.forEach(function(t){t.updateWanted(!0)}),this.firsttimeupdate=!0),this.dom.listheader_count.text(0!==this.itemsSelectedCt?this.itemsSelectedCt:"No"),this.facets.forEach(function(e){e.refreshAfterFilter(t)}),this.listDisplay&&this.listDisplay.updateAfterFiltering(),this.updateCb&&this.updateCb(this)},refreshFilterClearAll:function(){var t=0;this.filterList.forEach(function(e){t+=e.isFiltered?1:0}),this.dom.filterClearAll.style("display",t>0?"inline-block":"none")},clearResultPreview:function(){this.items.forEach(function(t){t.resultDOM&&t.resultDOM.setAttribute("highlight",!1)}),this.facets.forEach(function(t){t.clearResultPreview()})},refreshResultPreview:function(){this.facets.forEach(function(t){t.refreshResultPreview()})},updateLayout:function(){this.loaded===!0&&(this.divWidth=this.domWidth(),this.updateLayout_Height(),this.setBarWidthLeftPanel(this.barChartWidth))},updateLayout_Height:function(){var t=this,e=0,i=this.domHeight()-e,s=i;this.facets.forEach(function(t){t.heightProcessed=!1});var a=this.facets[0];if("scatterplot"===a.type&&(270>s?a.collapsedTime=!0:(a.setHeight(s/4),a.heightProcessed=!0,s-=a.getHeight_Total())),this.facetsBottom.length>0){var r=s/5;this.facetsBottom.forEach(function(t){t.setHeight(r),t.heightProcessed=!0}),s-=this.facetsBottom[0].getHeight_Total()}var o=function(e,i){var s=!1,a=0,r=!1;for(i.forEach(function(t){t.heightProcessed&&a++});;){var o=i.length-a;if(0===o&&10>e)break;var n=a;if(i.forEach(function(i){if(r===!0&&e>5&&!i.collapsed&&void 0!==i.attribCount_Total&&i.attribCount_InDisplay<i.attribCount_Total)return e+=i.getHeight_Total(),i.setHeight(e),e-=i.getHeight_Total(),void 0;if(!i.heightProcessed&&0!==o){var n=Math.floor(e/o);if(s&&n<i.getHeight_RangeMin()&&i.setCollapsed(!0),!i.collapsed)if(i.options.catDispCountFix){var l=i.getHeight_Header()+(i.options.catDispCountFix+1)*t.line_height;if(!s)return;l=Math.max(l,n),i.setHeight(l)}else if(i.getHeight_RangeMax()<=n)i.setHeight(i.getHeight_RangeMax());else if(s)i.setHeight(n);else if(!r)return;e-=i.getHeight_Total(),i.heightProcessed=!0,a++,o--}},this),s=n===a,r===!0)break;0===o&&(r=!0)}return e},n=o(s,this.facetsLeft);o(s,this.facetsRight);var l=i-n;if(this.facets.forEach(function(t){t.refreshHeight()}),this.listDisplay){var h;h=this.fullWidthResultSet()?l:"scatterplot"===a.type?a.getHeight_Right():0;var c=this.listDisplay.dom.listHeader[0][0].offsetHeight,r=i-h-c;if("scatterplot"===a.type)if(a.collapsedTime){var d=a.getHeight_Total()-h;this.listDisplay.listDiv.style("margin-top",-d+3+"px"),r-=3}else this.listDisplay.listDiv.style("margin-top","3px"),r-=3;this.facetsBottom.length>0&&(r-=this.facetsBottom[0].getHeight_Total()),this.listDisplay.dom.listItemGroup.style("height",r+"px")}},initBarChartWidth:function(){this.divWidth=this.domWidth();var t;if(this.fullWidthResultSet()&&this.isSmallWidth())t=this.divWidth-this.getRowTotalTextWidth()-this.scrollWidth;else if(t=this.barChartWidthInit,void 0===t){var e=this.divWidth-this.categoryTextWidth;this.facetsRight.length>0,e-=this.categoryTextWidth,t=Math.floor(e/10)}this.setBarWidthLeftPanel(t)},setBarWidthLeftPanel:function(t){if(t>200?(this.hideBars=!1,this.hideBarAxis=!1):t>45?(this.hideBars=!1,this.hideBarAxis=!1):t>10?(this.hideBars=!1,this.hideBarAxis=!0):(this.hideBars=!0,this.hideBarAxis=!0,t=0),this.forceHideBarAxis===!0&&(this.hideBarAxis=!0),this.hideBars===!1?this.root.attr("hidebars",!1):this.root.attr("hidebars",!0),this.hideBarAxis===!1?this.root.attr("hideBarAxis",!1):this.root.attr("hideBarAxis",!0),this.barChartWidth=t,this.facetBackground.style("width",this.getWidth_LeftPanel()+"px"),this.facets.forEach(function(t){t.hasAttribs()&&(t.updateBarAxisScale(),t.refreshBarGroupWidth(),"scatterplot"===t.type&&t.updateTimeWidth()),t.refreshWidth()},this),this.listDisplay){var e=this.divWidth,i=0,s=0;this.fullWidthResultSet()||(this.facetsLeft.length>0&&(i=2,e-=this.getWidth_LeftPanel()+2),this.facetsRight.length>0&&(s=2,e-=this.getWidth_LeftPanel()+2)),this.listDisplay.updateContentWidth(e),this.listDisplay.listDiv.style("width",e+"px"),this.layoutLeft.style("margin-right",i+"px"),this.layoutRight.style("margin-left",s+"px")}},isSmallWidth:function(){return this.categoryTextWidth+260>this.divWidth},fullWidthResultSet:function(){return 0==this.facetsLeft.length&&0==this.facetsRight.length?!0:this.isSmallWidth()?!0:!1},getFilteringState:function(){var t={resultCt:this.itemsSelectedCt};return this.facets.forEach(function(t){t.isFiltered()}),t.filtered="",t.selected="",this.filterList.forEach(function(e){if(e.isFiltered){if(void 0!==e.facet.attribCount_Selected&&0===e.facet.attribCount_Selected)return;""!==t.filtered&&(t.filtered+="x"),t.filtered+=e.id,""!==t.selected&&(t.selected+="x"),t.selected+=e.facet.attribCount_Selected?e.facet.attribCount_Selected:0}}),""===t.filtered&&(t.filtered=void 0),""===t.selected&&(t.selected=void 0),t}},kshf.Facet_Categorical=function(t,e){this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=e.items,this.options=e,this.layoutStr=e.layout,this.sortingOpts=e.sortingOpts.slice(),this.parentFacet=e.parentFacet,this.dom={},this.type=this.options.timeTitle?"scatterplot":"categorical",this.scrollTop_cache=0,this.attrib_InDisplay_First=0,this.configRowCount=0,this.collapsed=!1,e.collapsed===!0&&(this.collapsed=!0),this.skipSorting=!1,this.hasAttribs()&&this.initAttribs(e)},kshf.Facet_Categorical.prototype={getAttribs:function(){return kshf.dt[this.catTableName]},getAttribs_wID:function(){return kshf.dt_id[this.catTableName]},getWidth_Left:function(){return this.browser.getWidth_LeftPanel()-this.getWidth_LeftOffset()},getWidth_Header:function(){return this.browser.getWidth_LeftPanel()-(void 0!==this.parentFacet?this.getWidth_LeftOffset():0)},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight,this.hasFacets()&&(this._height_header+=2)),this._height_header},getHeight_Right:function(){return this.hasAttribs()?"scatterplot"!==this.type?this.getHeight_Header():this.collapsedTime===!0||this.collapsed===!0?1*this.browser.line_height:this.getHeight_Total():this.getHeight_Header()},getHeight_RangeMax:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+this.attribCount_Active+1)*this.browser.line_height:this.browser.line_height},getHeight_RangeMin:function(){return this.hasAttribs()?this.getHeight_Header()+(this.configRowCount+Math.min(this.attribCount_Active,3)+1)*this.browser.line_height:this.browser.line_height},getHeight_Total:function(){return this.hasAttribs()?this.collapsed?this.getHeight_Header():this.getHeight_Header()+this.getHeight_Content():this.getHeight_Header()},getHeight_Content:function(){var t=0;return(!this.allAttribsVisible()||this.browser.hideBarAxis===!1||"scatterplot"===this.type&&this.collapsedTime===!1)&&(t=1),this.attribHeight+(this.configRowCount+t)*this.browser.line_height+("scatterplot"===this.type?5:0)},getWidth_LeftOffset:function(){var t=0;return this.parentFacet?t+=17:this.hasFacets()&&(t+=17),t},getFilteredCount:function(){return this.isFiltered()+this.isFiltered_Time()},isFiltered:function(){return 0!==this.attribCount_Selected||this.attribCount_Wanted!==this.attribCount_Total},rowCount_Header_Right:function(){return"scatterplot"!==this.type?0:this.collapsedTime?1:2},allAttribsVisible:function(){return this.attribCount_Active===this.attribCount_InDisplay},setSelectType:function(t){this.attribFilter.selectType=t,this.divRoot.attr("selectType",this.attribFilter.selectType)},hasFacets:function(){return void 0!==this.subFacets},hasAttribs:function(){return void 0!==this.options.catItemMap},initAttribs:function(t){if(this.sortingOpts.forEach(function(t){void 0===t.no_resort&&(t.no_resort=!1),void 0===t.func&&(t.func=kshf.Util.sortFunc_ActiveCount_TotalCount),void 0===t.inverse&&(t.inverse=!1)}),this.sortingOpt_Active=this.sortingOpts[0],void 0===this.options.showNoneCat&&(this.options.showNoneCat=!1),void 0===this.options.removeInactiveAttrib&&(this.options.removeInactiveAttrib=!0),void 0===this.options.catLabelText&&(this.options.catLabelText=function(t){return t.data[1]}),void 0===this.options.catTableName?(this.catTableName=this.options.facetTitle+"_h_"+this.id,this.browser.createTableFromTable(this.filteredItems,this.catTableName,this.options.catItemMap,this.options.attribNameFunc)):(this.options.catTableName===this.browser.primaryTableName&&(this.isLinked=!0,this.options.catTableName=this.options.facetTitle+"_h_"+this.id,kshf.dt_id[this.options.catTableName]=kshf.dt_id[this.browser.primaryTableName],kshf.dt[this.options.catTableName]=this.filteredItems.slice()),this.catTableName=this.options.catTableName),void 0===this.isLinked&&(this.isLinked=!1),this.options.showNoneCat===!0){var e=1e4,i=new kshf.Item([e,"None"],0);kshf.dt[this.catTableName].push(i),kshf.dt_id[this.catTableName][e]=i;var s=this.options.catItemMap;this.options.catItemMap=function(t){var i=s(t);return null===i?e:void 0===i?e:i instanceof Array&&0===i.length?e:i};var a=this.options.catLabelText;if(this.options.catLabelText=function(t){return t.id()===e?"None":a(t)},this.options.catTooltipText){var r=this.options.catTooltipText;this.options.catTooltipText=function(t){return t.id()===e?"None":r(t)}}}this.attribFilter=this.browser.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.showTextSearch&&(this.dom.clearTextSearch.style("display","none"),this.dom.attribTextSearch[0][0].value=""),this.unselectAllAttribs()},onFilter:function(t,e){switch(this.updateItemFilterState_Attrib(),t.how){case"All":t.filteredItems.forEach(function(t){t.updateWanted(e)});break;case"LessResults":t.filteredItems.forEach(function(t){t.updateWanted_Less(e)});break;case"MoreResults":t.filteredItems.forEach(function(t){t.updateWanted_More(e)})}},text_header:this.options.textFilter?this.options.textFilter:this.options.facetTitle,text_item:this.text_item_Attrib}),this.attribFilter.selectType="SelectOr",this.mapAttribs(t),"scatterplot"===this.type&&(this.collapsedTime=!1,t.collapsedTime===!0&&(this.collapsedTime=!0),void 0===this.options.timeBarShow&&(this.options.timeBarShow=!1),this.timeRange={min:0,max:0,width:0},this.timeFilter=this.browser.createFilter({name:this.options.timeTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.dom.timeSlider.attr("filtered",!1),this.divRoot.attr("filtered_time",!1),this.resetTimeFilterActive(),this.resetTimeZoom_ms(),this.refreshTimechartLayout(!0),this.refreshTimeChart()},onFilter:function(t,e){this.dom.timeSlider.attr("filtered",!0),this.divRoot.attr("filtered_time",!0),this.refreshTimeChart(),t.filteredItems.forEach(function(i){var s=i.mappedDataCache[t.id];i.setFilter(t.id,s>=this.timeFilter.active.min&&s<=this.timeFilter.active.max),i.updateWanted(e)},this)},text_item:function(){return"from <b>"+this.getFilterMinDateText()+"</b> to <b>"+this.getFilterMaxDateText()+"</b>"}}),this.filteredItems.forEach(function(t){t.mappedDataCache[this.timeFilter.id]=this.options.timeItemMap(t)},this),this.x_axis_active_filter=null,this.timeData_dt={min:d3.min(this.filteredItems,this.options.timeItemMap),max:d3.max(this.filteredItems,this.options.timeItemMap)},this.updateAttrib_TimeMinMax(),this.getAttribs().forEach(function(t){t.xMin=t.xMin_Dyn,t.xMax=t.xMax_Dyn}))},insertSubFacets:function(){this.subFacets=[],this.dom.subFacets=this.divRoot.append("div").attr("class","subFacets"),this.dom.subFacets.append("span").attr("class","facetGroupBar").append("span"),this.hasAttribs()?this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr,t.items=this.getAttribs();var e=this.browser.addFacet(t,this.catTableName);this.subFacets.push(e)},this):this.options.facets.forEach(function(t){t.parentFacet=this,t.layout=this.layoutStr;var e=this.browser.addFacet(t,this.browser.primaryTableName);this.subFacets.push(e)},this),this.subFacets.forEach(function(t){t.init_DOM()})},mapAttribs:function(t){var e=this.attribFilter.id;this.browser.mapItemData(this.filteredItems,this.options.catItemMap,this.getAttribs_wID(),e),this.hasMultiValueItem=!1,this.filteredItems.forEach(function(t){var i=t.mappedDataCache[e];
null!==i&&i instanceof Array&&(this.hasMultiValueItem=!0)},this),this._dataMap=this.options.dataMap?this.isLinked?function(e){return t.dataMap(e)}:function(e){return 0===e.items.length?null:t.dataMap(e)}:this.isLinked?function(t){return t.id()}:function(t){return 0===t.items.length?null:t.id()},this.updateAttribCount_Total(),this.updateAttribCount_Active(),1===this.attribCount_Active&&(this.options.catBarScale="scale_frequency"),this.unselectAllAttribs()},updateAttribCount_Total:function(){this.attribCount_Total=0,this.getAttribs().forEach(function(t){null!==this._dataMap(t)&&this.attribCount_Total++},this),this.attribCount_Wanted=this.attribCount_Total,this.showTextSearch=this.options.forceSearch||this.options.forceSearch!==!1&&this.attribCount_Total>=20},updateAttribCount_Wanted:function(){this.attribCount_Wanted=0,this.getAttribs().forEach(function(t){0!==t.items.length&&t.isWanted&&this.attribCount_Wanted++},this)},updateAttribCount_Active:function(){this.attribCount_Active=0,this.getAttribs().forEach(function(t){null!==this._dataMap(t)&&this.isAttribVisible(t)!==!1&&this.attribCount_Active++},this)},init_DOM:function(){var t,e=this;if(this.parentFacet)t=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":t=this.browser.layoutLeft;break;case"right":t=this.browser.layoutRight;break;case"top":t=this.browser.layoutTop;break;case"bottom":t=this.browser.layoutBottom;break;case"bottomleft":t=this.browser.layoutBottom}this.divRoot=t.append("div").attr("class","kshfChart").attr("removeInactiveAttrib",this.options.removeInactiveAttrib).attr("filtered",!1).attr("inserted_attrib",!1).attr("collapsed",this.collapsed===!1?"false":"true").attr("hasMultiValueItem",this.hasMultiValueItem).on("mouseleave",function(){e.skipSorting&&e.hasAttribs()&&(e.skipSorting=!1,setTimeout(function(){e.updateSorting(0)},750)),setTimeout(function(){e.browser.updateLayout_Height()},1500)}),this.insertHeader(),"scatterplot"===this.type&&this.insertRightHeader(),this.hasAttribs()&&this.init_DOM_Attrib(),this.options.facets&&(this.divRoot.attr("hasFacets",!0),this.insertSubFacets(),this.refreshLabelWidth())},init_DOM_Attrib:function(){var t=this;if(this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.options.facets&&this.dom.wrapper.append("span").attr("class","facetGroupBar").append("span"),this.dom.facetCategorical=this.dom.wrapper.append("div").attr("class","facetCategorical"),this.options.facets&&this.dom.facetCategorical.style("margin-left","17px"),this.dom.facetControls=this.dom.facetCategorical.append("div").attr("class","facetControls"),this.dom.leftControls=this.dom.facetControls.append("span").attr("class","leftControls"),this.sortingOpts.length>1&&(this.insertSortingOpts(),this.configRowCount++),this.showTextSearch&&(this.insertLabelTextSearch(),this.configRowCount++),"scatterplot"===this.type){0===this.configRowCount&&(this.configRowCount=1),this.dom.rightControls=this.dom.facetControls.append("span").attr("class","rightControls");var e=this.dom.rightControls.append("span").attr("class","config_zoom");e.append("span").attr("class","zoom_button zoom_in").attr("disabled","true").text("⇥ Zoom in ⇤").on("click",function(){t.timeZoom_ms={min:t.timeFilter.active.min,max:t.timeFilter.active.max},t.useCurrentTimeMinMax=!0,t.refreshTimechartLayout(!0),t.useCurrentTimeMinMax=void 0,t.divRoot.select(".zoom_out").attr("disabled","false"),t.divRoot.select(".zoom_in").attr("disabled","true")}),e.append("span").attr("class","zoom_button zoom_out").attr("disabled","true").text("⇤ Zoom out ⇥").on("click",function(){t.resetTimeZoom_ms(),t.useCurrentTimeMinMax=!0,t.refreshTimechartLayout(!0),t.useCurrentTimeMinMax=void 0,t.divRoot.select(".zoom_out").attr("disabled","true")})}this.configRowCount>0&&this.dom.facetControls.style("display","block"),this.dom.facetCategorical.append("div").attr("class","scrollToTop").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],0),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_TOP,{id:t.id})}),this.dom.scrollToTop=this.dom.facetCategorical.selectAll(".scrollToTop"),"scatterplot"===this.type&&(this.dom.middleScrollbar=this.dom.facetCategorical.append("span").attr("class","middleScrollbar").on("scroll",function(){t.dom.attribGroup[0][0].scrollTop=this.scrollTop}),this.dom.middleScrollbar.append("div").attr("class","filler"),this.dom.selectVertLine=this.dom.facetCategorical.append("span").attr("class","selectVertLine")),this.dom.attribGroup=this.dom.facetCategorical.append("div").attr("class","attribGroup").on("scroll",function(){kshf.Util.ignoreScrollEvents!==!0&&(t.dom.scrollToTop.style("visibility",this.scrollTop>0?"visible":"hidden"),"scatterplot"===t.type&&(t.dom.middleScrollbar.select(".filler").style("height",this.scrollHeight+"px"),t.dom.middleScrollbar[0][0].scrollTop=this.scrollTop),t.scrollTop_cache=this.scrollTop,t.attrib_InDisplay_First=Math.floor(this.scrollTop/(1*t.browser.line_height)),t.refreshScrollDisplayMore(t.attrib_InDisplay_First+t.attribCount_InDisplay))}),this.dom.belowAttribs=this.dom.facetCategorical.append("div").attr("class","belowAttribs"),this.dom.belowAttribs.append("div").attr("class","border_line"),this.dom.attribChartAxis=this.dom.belowAttribs.append("div").attr("class","attribChartAxis"),this.dom.attribs=this.dom.attribGroup.selectAll("div.attib").data(this.getAttribs(),function(t){return t.id()}).enter().append("div").attr("class",function(e){var i="attrib";return t.options.domStyle&&(i+=" "+t.options.domStyle.call(this,e)),i}).each(function(e){e.facet=t,e.facetDOM=this,this.isLinked=t.isLinked}),"scatterplot"===this.type&&(this.divRoot.attr("filtered_time",!1),void 0!==this.options.timeDotConfig&&this.divRoot.attr("dotconfig",this.options.timeDotConfig),this.dom.timeChartAxis=this.dom.belowAttribs.append("div").attr("class","timeChartAxis"));var i=this.dom.belowAttribs.append("div").attr("class","hasLabelWidth");this.dom.scroll_display_more=i.append("span").attr("class","scroll_display_more").on("mousedown",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],t.dom.attribGroup[0][0].scrollTop+18),sendLog&&sendLog(kshf.LOG.FACET_SCROLL_MORE,{id:t.id})}),this.isLinked&&i.append("span").attr("class","selectAllAttribs").on("click",function(){t.selectAllAttribs(),t.setSelectType("SelectOr"),t.attribFilter.how="All",t.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR_ALL,{id:t.attribFilter.id})}),this.insertAttribs(),"scatterplot"===this.type&&(this.dom.facetCategorical.append("div").attr("class","scrollToTop scrollToTop2").html("⬆").attr("title","Scroll To Top").on("click",function(){kshf.Util.scrollToPos_do(t.dom.attribGroup[0][0],0)}),this.dom.timeSlider=this.dom.timeChartAxis.append("div").attr("class","timeSlider rangeSlider").attr("filtered",!1).attr("anim",!0),kshf.Util.insertSlider_do(this.dom.timeSlider,{range:this.timeRange,scale:"timeScale",filter:this.timeFilter,root:this.browser.root}),this.dom.timeLabelGroup=this.dom.timeChartAxis.append("div").attr("class","timeLabelGroup labelGroup"),this.insertTimeChartRows())},getMaxTotalItemsPerRow:function(){if(!this._maxTotalItemsPerRow){var t=this._dataMap;this._maxTotalItemsPerRow=d3.max(this.getAttribs(),function(e){return null===t(e)?null:e.items.length})}return this._maxTotalItemsPerRow},getMaxBarValuePerAttrib:function(){return d3.max(this.getAttribs(),function(t){return t.itemCount_Active})},getMaxBarValueMaxPerAttrib:function(){return this._maxBarValueMaxPerAttrib?this._maxBarValueMaxPerAttrib:this.hasAttribs()?(this._maxBarValueMaxPerAttrib=d3.max(this.getAttribs(),function(t){return t.items.length}),this._maxBarValueMaxPerAttrib):0},attrib_UnselectAll:function(){this.attribCount_Included=0,this.attribCount_Removed=0,this.divRoot&&this.divRoot.attr("inserted_attrib",!1),this._update_Selected()},attrib_Include:function(t){this.attribCount_Included+=t,this.divRoot&&this.divRoot.attr("inserted_attrib",this.attribCount_Included>0),this._update_Selected()},attrib_Remove:function(t){this.attribCount_Removed+=t,this._update_Selected()},attrib_setIncluded:function(t){this.attribCount_Included=t,this.divRoot&&this.divRoot.attr("inserted_attrib",this.attribCount_Included>0),this._update_Selected()},_update_Selected:function(){this.attribCount_Selected=this.attribCount_Included+this.attribCount_Removed,this.divRoot&&this.divRoot.attr("filtered",this.attribCount_Selected>0)},selectAllAttribs:function(){this.isLinked&&(this.attribCount_Included=0,this.attribCount_Removed=0,this.getAttribs().forEach(function(t){t.selectedForLink&&(t.f_include(),this.attribCount_Included++)},this),this.divRoot&&this.divRoot.attr("inserted_attrib",this.attribCount_Included>0),this._update_Selected())},unselectAllAttribs:function(){this.getAttribs().forEach(function(t){t.f_selected()&&t.facetDOM&&t.facetDOM.setAttribute("highlight",!1),t.f_unselect()}),this.attrib_UnselectAll()},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true"),this.hasFacets()&&!this.hasAttribs()&&this.subFacets.forEach(function(e){e.setCollapsed(t)})},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},insertHeader:function(){var t=this;this.dom.headerGroup=this.divRoot.append("div").attr("class","headerGroup"),this.dom.leftHeader=this.dom.headerGroup.append("span").attr("class","leftHeader"),this.options.facets&&this.dom.leftHeader.append("div").attr("class","border_line").style("height","4px");var e=this.dom.leftHeader.append("div").attr("class","chartFirstLineBackground");this.dom.leftHeader.append("div").attr("class","border_line");var i=e.append("div").attr("class","hasLabelWidth").style("position","relative").style("display","inline-block");i.append("span").attr("class","header_label_arrow").attr("title","Show/Hide").on("click",function(){t.collapseFacet(!t.collapsed)}).append("span").text("▼"),i.append("span").attr("class","chartFilterButtonParent").append("div").attr("class","chartClearFilterButton rowFilter alone").style("top","calc(40% - 7px)").text("x").attr("title","Remove filter").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,title:function(){return"<span class='big'>x</span class='big'> <span class='action'>Remove</span> filter"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.attribFilter.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_X,{id:t.attribFilter.id})});var s=this.options.facetTitle;this.parentFacet&&this.parentFacet.hasAttribs()&&(s=s+" <i class='fa fa-chevron-right'></i> "+this.parentFacet.options.facetTitle),i.append("span").attr("class","header_label").html(s).on("click",function(){t.collapsed&&t.collapseFacet(!1)});var a=e.append("span").attr("class","facetIcons");this.options.description&&a.append("span").attr("class","facetDescription fa fa-info-circle").each(function(){this.tipsy=new Tipsy(this,{gravity:"nw",fade:!0,title:function(){return t.options.description}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.isLinked?a.append("span").attr("class","isLinkedMark fa fa-check-square-o"):this.parentFacet&&a.append("span").attr("class","isLinkedMark fa fa-level-up")},insertLabelTextSearch:function(){var t=this,e=this.dom.leftControls.append("div").attr("class","attribTextSearch hasLabelWidth");this.dom.attribTextSearch=e.append("input").attr("type","text").attr("placeholder","Search").on("input",function(){this.timer&&clearTimeout(this.timer);var i=this;this.timer=setTimeout(function(){var s=i.value.toLowerCase();""===s?t.attribFilter.clearFilter(!0):(e.select("i.fa").style("display","block"),t.attrib_UnselectAll(),t.getAttribs().forEach(function(e){-1!==t.options.catLabelText(e).toString().toLowerCase().indexOf(s)?e.f_include():t.options.catTooltipText&&-1!==t.options.catTooltipText(e).toLowerCase().indexOf(s)?e.f_include():e.f_unselect(),e.f_included()&&t.attrib_Include(1)}),t.isFiltered()?(t.setSelectType("SelectOr"),t.attribFilter.how="All",t.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_TEXTSEARCH,{id:t.attribFilter.id,info:s})):t.attribFilter.clearFilter(!0))},750)}).on("blur",function(){d3.event.stopPropagation(),d3.event.preventDefault()}),e.append("i").attr("class","fa fa-search searchIcon"),this.dom.clearTextSearch=e.append("i").attr("class","fa fa-times-circle clearText").on("click",function(){t.attribFilter.clearFilter(!0)})},insertSortingOpts:function(){var t=this,e=this.dom.leftControls.append("span").attr("class","sortOptionSelectGroup hasLabelWidth");e.append("span").attr("class","optionSelect_Label").text("Order by"),e.append("select").attr("class","optionSelect").on("change",function(){t.sortingOpt_Active=t.sortingOpts[this.selectedIndex],t.updateSorting_do.call(t,0),sendLog&&sendLog(kshf.LOG.FACET_SORT,{id:t.id,info:this.selectedIndex})}).selectAll("input.sort_label").data(this.sortingOpts).enter().append("option").attr("class","sort_label").text(function(t){return t.name})},updateBarAxisScale:function(){if(this.hasAttribs()){var t=this;this.catBarAxisScale=d3.scale.linear().rangeRound([0,this.browser.barChartWidth]).nice(this.getTicksSkip()).clamp(!0),"scale_frequency"===this.options.catBarScale?this.catBarAxisScale.domain([0,this.browser.itemsSelectedCt]):this.catBarAxisScale.domain([0,this.getMaxBarValuePerAttrib()]),this.refreshWidth_Bars_Active(),this.refreshWidth_Bars_Total(),this.dom.bar_highlight.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bar_highlight.attr("fast",!0)},700),this.refresh_Bars_Ticks()}},setHeight:function(t){if(this.hasAttribs()){var e=t-this.getHeight_Header()-(1+this.configRowCount)*this.browser.line_height;this.attribHeight=Math.min(e,this.browser.line_height*this.attribCount_Active),e=Math.floor(e/this.browser.line_height),0>e&&(e=1),e>this.attribCount_Active&&(e=this.attribCount_Active),e=this.attribCount_Active<=2?this.attribCount_Active:Math.max(e,2),this.attribCount_InDisplay=e,this.refreshScrollDisplayMore(this.attribCount_InDisplay)}},refreshAfterFilter:function(){this.hasAttribs()&&(this.refreshActiveItemCount(),this.updateBarAxisScale(),this.skipSorting?this.refreshWidth_Bars_Active():this.updateSorting(),"scatterplot"===this.type&&(this.refreshTimeChartBarDisplay(),this.refreshTimeChartDotConfig()))},refreshWidth:function(){var t=this.browser,e=this.getWidth_Left(),i=this.browser.getWidth_Total();this.dom.leftHeader.style("width",this.getWidth_Header()+"px"),this.hasAttribs()&&this.dom.leftControls.style("width",e+"px"),"scatterplot"===this.type&&(this.dom.rightHeader.style("width",i-e+"px"),this.dom.rightControls.style("width",i-e+"px"),this.dom.middleScrollbar.style("left",e-t.scrollWidth+1+"px"),this.dom.facetCategorical.select(".scrollToTop2").style("left",e-15+"px"),this.dom.timeChartAxis.style("width",this.timeRange.width+"px").style("left",e+t.sepWidth+"px"),this.collapsedTime?this.dom.attribGroup.style("width",e+"px"):this.dom.attribGroup.style("width","auto"))},refreshActiveItemCount:function(){var t=this,e=kshf.Util.formatForItemCount;this.dom.item_count.text(function(t){return e(t.itemCount_Active)}),this.dom.attribs.attr("noitems",function(e){return!t.isAttribSelectable(e)}).attr("itemCount_Active",function(t){return t.itemCount_Active})},refreshBarGroupWidth:function(){this.dom.barGroup.style("width",this.browser.barChartWidth+"px")},refreshWidth_Bars_Active:function(){var t=this;this.dom.bar_active.each(function(e){var i="scaleX("+t.catBarAxisScale(e.itemCount_Active)+")";kshf.Util.setTransform(this,i)})},refreshWidth_Bars_Total:function(){var t=this;this.dom.bar_total.each(function(e){var i="scaleX("+t.catBarAxisScale(e.items.length)+")";kshf.Util.setTransform(this,i)})},clearResultPreview:function(){if(this.hasAttribs()&&!this.collapsed){var t=this;this.dom.bar_highlight.each(function(e){if(e.itemCount_Preview=0,!(e.orderIndex<t.attrib_InDisplay_First||e.orderIndex>t.attrib_InDisplay_First+t.attribCount_InDisplay+3)){var i="scaleX(0)";kshf.Util.setTransform(this,i)}})}},refreshResultPreview:function(){if(this.hasAttribs()&&!this.collapsed){var t=this;this.dom.bar_highlight.each(function(e){if(!(e.orderIndex<t.attrib_InDisplay_First||e.orderIndex>t.attrib_InDisplay_First+t.attribCount_InDisplay+1)){var i="scaleX("+t.catBarAxisScale(e.itemCount_Preview)+")";kshf.Util.setTransform(this,i)}})}},refreshLabelWidth:function(){var t=this.browser,e=this.browser.categoryTextWidth,i=this.getWidth_LeftOffset(),s=e;this.parentFacet&&(s-=i),e-=i,this.dom.headerGroup.selectAll(".hasLabelWidth").style("width",s+"px"),this.hasAttribs()&&(this.dom.facetCategorical.selectAll(".hasLabelWidth").style("width",e+"px"),this.dom.attribChartAxis.each(function(){var e=t.getRowTotalTextWidth()-i,s="translateX("+e+"px)";kshf.Util.setTransform(this,s)}))},refreshScrollDisplayMore:function(t){var e=this.attribCount_Active+" total",i=this.attribCount_Active-t;i>0&&(e+=" / "+i+" more..."),this.dom.scroll_display_more.text(e)},refreshHeight:function(){this.hasAttribs()&&(this.dom.wrapper.style("height",(this.collapsed?"0":this.getHeight_Content())+"px"),"scatterplot"===this.type&&this.dom.scroll_display_more.style("height","22px"),this.dom.attribGroup.style("height",this.attribHeight+"px"),this.dom.attribChartAxis.selectAll("span.line").style("top","-"+(this.attribHeight-8)+"px").style("height",this.attribHeight-8+"px"),"scatterplot"===this.type&&this.refreshTimeAxisHeight())},updateItemFilterState_Attrib:function(){if(this.isFiltered()){var t=kshf.Util.filter_multi_removed,e=this.attribFilter.id;if("SelectAnd"===this.attribFilter.selectType){var i=kshf.Util.filter_multi_and;this.filteredItems.forEach(function(s){var a=s.mappedDataCache[e],r=!1;null!==a?r=a instanceof Array?this.attribCount_Removed>0&&t.call(this,a)?!1:this.attribCount_Included>0?i.call(this,a):!0:!1:0===this.attribCount_Included&&(r=!0),s.setFilter(e,r)},this)}else{var i=kshf.Util.filter_multi_or;this.filteredItems.forEach(function(s){var a=s.mappedDataCache[e],r=!1;null!==a?a instanceof Array?r=this.attribCount_Removed>0&&t.call(this,a)?!1:this.attribCount_Included>0?i.call(this,a):this.attribCount_Wanted<this.attribCount_Total?!a.every(function(t){return!t.isWanted}):!0:a.f_removed()||(r=0===this.attribCount_Included?this.attribCount_Wanted<this.attribCount_Total?a.isWanted:!0:a.f_included()):0===this.attribCount_Included&&(r=!0),s.setFilter(e,r)},this)}}},isAttribVisible:function(t){return this.isLinked?t.selectedForLink===!1?!1:!0:t.f_selected()?!0:0!==t.itemCount_Active?!0:this.attribCount_Wanted<this.attribCount_Total&&!t.isWanted?!1:this.options.removeInactiveAttrib===!1?!0:this.isFiltered()?"SelectAnd"===this.attribFilter.selectType?!1:t.isWanted===!1?!1:!0:0!==t.itemCount_Active},isAttribSelectable:function(t){return t.f_selected()?!0:0!==t.itemCount_Active?!0:this.isFiltered()&&!this.hasMultiValueItem?!0:!1},removeAttrib:function(t){if(this.skipSorting=!0,t.f_removed())t.f_unselect(),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_UNSELECT,{id:this.attribFilter.id,info:t.id()});else{if(t.itemCount_Active===this.browser.itemsSelectedCt)return alert("Removing this attribute would make an empty result set, so it is not allowed."),void 0;t.f_remove(),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_NOT,{id:me.attribFilter.id,info:t.id()})}return this.attrib_Remove(t.f_removed()?1:-1),this.isFiltered()?(this.attribFilter.how=t.f_removed()?"LessResults":"MoreResults",this.dom.attribTextSearch&&(this.dom.attribTextSearch[0][0].value=""),this.attribFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_REMOVE),void 0):(this.attribFilter.clearFilter(!0),void 0)},filterAttrib:function(t,e,i){if(this.skipSorting=!0,t.f_included())t.f_unselect(),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_UNSELECT,{id:this.attribFilter.id,info:t.id()});else{if(t.f_removed())return this.removeAttrib(t),void 0;t.f_include()}return this.attrib_Include(t.f_included()?1:-1),this.isFiltered()?(t.f_included()?1===this.attribCount_Included?(this.setSelectType("SelectOr"),this.attribFilter.how="LessResults"):this.hasMultiValueItem?(2===this.attribCount_Included&&this.setSelectType(e?"SelectOr":"SelectAnd"),this.attribFilter.how="SelectAnd"===this.attribFilter.selectType?"LessResults":"MoreResults"):e===!0?this.attribFilter.how="MoreResults":(t.skipMouseOut=!0,this.unselectAllAttribs(),t.f_include(),this.attrib_setIncluded(1),this.attribFilter.how="All"):this.hasMultiValueItem?(this.attribFilter.how="SelectAnd"===this.attribFilter.selectType?"MoreResults":"LessResults",1===this.attribCount_Included&&this.setSelectType("SelectOr")):this.attribFilter.how="LessResults",this.dom.attribTextSearch&&(this.dom.attribTextSearch[0][0].value=""),i&&(this.attribFilter.how=i),this.attribFilter.addFilter(!0),void 0):(this.attribFilter.clearFilter(!0),void 0)},text_item_Attrib:function(){if(this.isLinked)return"<b>"+this.attribCount_Included+"</b>";var t="",e=0,i=this.options.catLabelText,s=this.options.catTooltipText;return this.getAttribs().forEach(function(a){if(a.f_selected()){0!==e&&(t+="SelectAnd"===this.attribFilter.selectType||a.f_removed()?" and ":" or ");var r=i(a);a.f_removed()&&(r="not "+r);var o=r;s&&(o=s(a)),t+="<b>"+r+"</b>",e++}},this),t},insertAttribs:function(){var t=this,e=this.browser,i=null,s=function(e){if(e.facetDOM.tipsy_active&&e.facetDOM.tipsy_active.hide(),this.timer)return t.unselectAllAttribs(),t.filterAttrib(e,!1,"All"),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_EXACT,{id:t.attribFilter.id,info:e.id()}),void 0;t.filterAttrib(e,!1),sendLog&&e.f_selected()&&(1===t.attribCount_Selected?sendLog(kshf.LOG.FILTER_ATTR_ADD_ONE,{id:t.attribFilter.id,info:e.id()}):sendLog("SelectOr"===t.attribFilter.selectType?kshf.LOG.FILTER_ATTR_ADD_OR:kshf.LOG.FILTER_ATTR_ADD_AND,{id:t.attribFilter.id,info:e.id()}));var i=this;this.timer=setTimeout(function(){i.timer=null},500)},a=function(e){if(t.isAttribSelectable(e)){t.browser.pauseResultPreview||(e.items.forEach(function(e){e.updatePreview(t)}),e.highlightAll(),t.browser.refreshResultPreview(),sendLog&&(i&&clearTimeout(i),i=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.attribFilter.id,info:e.id()})},1e3))),e.facetDOM.tipsy_active=e.facetDOM.tipsy,!e.f_selected()&t.attribCount_Included>1&&"SelectOr"===t.attribFilter.selectType&&t.hasMultiValueItem&&(e.facetDOM.tipsy_active=d3.select(e.facetDOM).select(".filter_add_more .add")[0][0].tipsy);var s=t.catBarAxisScale(e.itemCount_Active);s=t.catBarAxisScale.range()[1]-s,"scatterplot"===t.type&&(s+=t.timeRange.width+t.browser.scrollWidth),e.facetDOM.tipsy_active.options.offset_x=t.browser.hideBars?0:-s,e.facetDOM.tipsy_active.show()}},r=function(e){return void 0!==e.skipMouseOut&&e.skipMouseOut===!0?(e.skipMouseOut=!1,void 0):(t.isAttribSelectable(e)&&(e.nohighlightAll(),i&&clearTimeout(i),t.browser.pauseResultPreview||t.browser.clearResultPreview(),e.facetDOM.tipsy_active&&e.facetDOM.tipsy_active.hide()),void 0)};this.dom.attribs.attr("highlight","false").attr("selected","0").each(function(){var t="translateY(0px)";kshf.Util.setTransform(this,t)}).each(function(){this.tipsy=new Tipsy(this,{gravity:"w",offset_x:2,offset_y:-1,fade:!0,title:function(){var e=this.__data__,i=t.options.facetTitle,s=e.facet.hasMultiValueItem;return e.f_included()||e.f_removed()?"<span class='fa fa-minus'></span> <span class='action'>Remove</span> from filter":0===e.facet.attribCount_Included?"<span class='fa fa-plus'></span> <span class='action'>Add</span> <i> filter":s===!1?"<span class='big'>&laquo;</span> <span class='action'>Change</span> filter":"<span class='fa fa-plus'></span> <span class='action'>Add</span> <i>"+i+"</i> (<b> ... and </b>)"}})}),this.dom.attribs.append("span").attr("class","clickArea").style("width",e.getRowTotalTextWidth()-20+"px").on("click",s).on("mouseover",a).on("mouseout",r),this.dom.attrLabel=this.dom.attribs.append("span").attr("class","attribLabel hasLabelWidth"),this.dom.add_more=this.dom.attrLabel.append("span").attr("class","filter_add_more"),this.dom.add_more.append("span").attr("class","add").text("⊕").each(function(){this.tipsy=new Tipsy(this,{gravity:"sw",offset_y:6,fade:!0,title:function(){return this.__data__,"<span class='big'>+</span> <span class='action'>Add</span> <i>"+t.options.facetTitle+"</i> (<b> ... or </b>)"}})}).on("mouseover",function(){this.tipsy.show(),this.parentNode.parentNode.parentNode.setAttribute("highlight",!0),d3.event.stopPropagation()}).on("mouseout",function(){this.tipsy.hide(),this.parentNode.parentNode.parentNode.setAttribute("highlight",!1),d3.event.stopPropagation()}).on("click",function(e){t.filterAttrib(e,!0),sendLog&&sendLog(kshf.LOG.FILTER_ATTR_ADD_OR,{id:t.attribFilter.id,info:e.id()}),this.tipsy.hide(),d3.event.stopPropagation()}),this.dom.add_more.append("span").attr("class","remove").text("⊖").each(function(){this.tipsy=new Tipsy(this,{gravity:"sw",offset_y:5,offset_x:1,fade:!0,title:function(){return this.__data__,"<span class='big'>+</span> <span class='action'>Remove</span> <i>"+t.options.facetTitle+"</i>"}})}).on("mouseover",function(){this.tipsy.show(),this.parentNode.parentNode.parentNode.setAttribute("highlight",!0),d3.event.stopPropagation()}).on("mouseout",function(){this.tipsy.hide(),this.parentNode.parentNode.parentNode.setAttribute("highlight",!1),d3.event.stopPropagation()}).on("click",function(e){t.removeAttrib(e),this.tipsy.hide(),d3.event.stopPropagation()}),this.dom.attrLabel.append("span").attr("class","theLabel").html(this.options.catLabelText),this.dom.item_count_wrapper=this.dom.attribs.append("span").attr("class","item_count_wrapper").style("width",this.browser.getRowLabelOffset()+"px"),this.dom.item_count=this.dom.item_count_wrapper.append("span").attr("class","item_count"),this.dom.barGroup=this.dom.attribs.append("span").attr("class","barGroup"),this.dom.bar_total=this.dom.barGroup.append("span").attr("class",function(e,i){return"bar total "+(t.options.barClassFunc?t.options.barClassFunc(e,i):"")}),this.dom.bar_active=this.dom.barGroup.append("span").attr("class",function(e,i){return"bar active "+(t.options.barClassFunc?t.options.barClassFunc(e,i):"")}).on("click",s).on("mouseover",a).on("mouseout",r),this.dom.bar_highlight=this.dom.barGroup.append("span").attr("class","bar hover").attr("fast",!0),this.dom.allRowBars=this.dom.attribs.selectAll("span.bar"),"scatterplot"===this.type&&(this.dom.row_bar_line=this.dom.barGroup.insert("span",":first-child").attr("class","row_bar_line")),this.refreshLabelWidth(),this.updateSorting()},sortAttribs:function(){void 0===this.sortingOpt_Active&&(this.sortingOpt_Active=this.sortingOpts[0]);var t=this.sortingOpt_Active.no_resort!==!0,e=this.sortingOpt_Active.inverse,i=this.sortingOpt_Active.func,s=function(t,e){return e-t};"string"==typeof this.getAttribs()[0].id()&&(s=function(t,e){return e.localeCompare(t)});var a=function(a,r){if(a.selectedForLink&&!r.selectedForLink)return-1;if(r.selectedForLink&&!a.selectedForLink)return 1;if(t){if(!a.f_selected()&&r.f_selected())return 1;if(a.f_selected()&&!r.f_selected())return-1}if(0===a.itemCount_Active&&0!==r.itemCount_Active)return 1;if(0===r.itemCount_Active&&0!==a.itemCount_Active)return-1;if(!a.isWanted&&r.isWanted)return 1;if(a.isWanted&&!r.isWanted)return-1;var o=i(a,r);return 0===o&&(o=s(a.id(),r.id())),e&&(o=-o),o};this.getAttribs().sort(a),this.getAttribs().forEach(function(t,e){t.orderIndex=e})},updateSorting:function(t){this.options.removeInactiveAttrib&&this.updateAttribCount_Active(),this.refreshScrollDisplayMore(this.attribCount_InDisplay),this.updateSorting_do(t)},updateSorting_do:function(t){var e=this.browser.line_height,i=this;void 0===t&&(t=1e3),this.sortAttribs(),setTimeout(function(){i.dom.attribs.each(function(t){var s=i.isAttribVisible(t);if(this.style.display=s?"block":"none",s){var a=t.orderIndex,r="translateY("+e*a+"px)";kshf.Util.setTransform(this,r)}})},t);var s=i.dom.attribGroup[0][0];0!==this.scrollTop_cache&&kshf.Util.scrollToPos_do(s,0),"scatterplot"===i.type&&(i.refreshBarLineColor(),setTimeout(function(){i.dom.middleScrollbar.select(".filler").style("height",s.scrollHeight+"px")},1500),i.dom.middleScrollbar[0][0].scrollTop=s.scrollTop)},getTicksSkip:function(){var t=this.browser.barChartWidth/25;return this.getMaxBarValuePerAttrib()>1e5&&(t=this.browser.barChartWidth/30),t},refresh_Bars_Ticks:function(){var t=this,e=this.attribHeight,i=this.catBarAxisScale.ticks(this.getTicksSkip());i=i.filter(function(t){return 0===t%1});var s=this.dom.attribChartAxis.selectAll("span.tick").data(i,function(t){return t}),a=this.browser.root.attr("noanim");"true"!==a&&this.browser.root.attr("noanim",!0);var r=function(e){var i=t.catBarAxisScale(e),s="translateX("+i+"px)";kshf.Util.setTransform(this,s)},o=s.enter().append("span").attr("class","tick").each(r);"true"!==a&&this.browser.root.attr("noanim",!1),o.append("span").attr("class","line").style("top","-"+e+"px").style("height",e+"px"),o.append("span").attr("class","text").text(function(t){return d3.format("s")(t)}),setTimeout(function(){t.dom.attribChartAxis.selectAll("span.tick").style("opacity",1).each(r)}),s.exit().remove()},insertRightHeader:function(){var t=this;this.divRoot.attr("collapsedTime",this.collapsedTime===!1?"false":"true"),this.dom.rightHeader=this.dom.headerGroup.append("span").attr("class","rightHeader");var e=this.dom.rightHeader.append("div").attr("class","chartFirstLineBackground chartFirstLineBackgroundRight");e.append("span").attr("class","header_label_arrow").attr("title","Show/Hide categories").on("click",function(){t.collapseTime(!t.collapsedTime)}).append("span").text("▼"),e.append("span").attr("class","header_label").html(this.options.timeTitle).on("click",function(){t.collapsedTime&&t.collapseTime(!1)}),e.append("div").attr("class","chartClearFilterButton timeFilter alone").attr("title","Remove filter").on("click",function(){t.timeFilter.clearFilter(!0)}).text("x"),this.dom.rightHeader.append("div").attr("class","border_line")},collapseTime:function(t){this.collapsedTime=t,this.browser.updateLayout_Height(),this.divRoot.attr("collapsedTime",this.collapsedTime===!1?"false":"true"),this.refreshWidth()},isFiltered_Time:function(){return"scatterplot"!==this.type?!1:this.timeFilter.active.min!==this.timeRange.min||this.timeFilter.active.max!==this.timeRange.max},resetTimeFilterActive:function(){this.timeFilter.active={min:this.timeRange.min,max:this.timeRange.max}},resetTimeZoom_ms:function(){this.timeZoom_ms={min:this.timeRange.min,max:this.timeRange.max}},updateTimeWidth:function(){var t=this.browser;this.timeRange.width=t.divWidth-t.getWidth_LeftPanel()-2*t.sepWidth-20,this.refreshTimechartLayout(!0),this.updateRowBarLineWidth(),this.dom.timeChartAxis.style("width",this.timeRange.width+"px"),this.dom.timeLineParts.style("width",this.timeRange.width+"px")},refreshBarLineColor:function(){this.dom.row_bar_line.style("border-top-color",function(t){return 1===t.orderIndex%2?"gray":"lightgray"})},updateRowBarLineWidth:function(){var t=this.browser;this.dom.row_bar_line.style("width",t.barChartWidth+t.scrollWidth+this.timeRange.width+t.sepWidth+"px")},updateAttrib_TimeMinMax:function(){var t=this.timeFilter.id,e=function(e){return e.isWanted?e.mappedDataCache[t]:void 0};this.getAttribs().forEach(function(t){t.sortDirty!==!1&&(t.xMin_Dyn=d3.min(t.items,e),t.xMax_Dyn=d3.max(t.items,e))})},refreshTimechartLayout:function(t){this.setTimeTicks(),this.updateTimeChartBarsDots(),this.refreshTimeChartBarDisplay(),this.insertTimeTicks(),this.insertTimeChartAxis(),t===!0&&this.refreshTimeChartDotConfig()},refreshTimeChartDotConfig:function(){if("scatterplot"===this.type&&void 0===this.options.timeDotConfig&&this.skipUpdateTimeChartDotConfig!==!0){var t=this,e=0;this.dom.attribs.each(function(i){(!t.isFiltered()||i.f_selected())&&void 0!==i.xMax_Dyn&&void 0!==i.xMin_Dyn&&(e+=t.timeScale(i.xMax_Dyn)-t.timeScale(i.xMin_Dyn))}),this.timeFilter.active.max-this.timeFilter.active.min,this.timeZoom_ms.max-this.timeZoom_ms.min;
var i=12,s=e/i,a=this.browser.itemsSelectedCt;s>3*a||0===e?this.dom.timeDots.attr("fill","default"):(this.dom.timeDots.attr("fill","gradient100"),s>1.5*a?this.dom.timeDots.attr("fill","gradient100"):s>.8*a?this.dom.timeDots.attr("fill","gradient75"):s>.3*a?this.dom.timeDots.attr("fill","gradient50"):this.dom.timeDots.attr("fill","gradient25"))}},refreshTimeChartBarDisplay:function(){var t=this;this.browser;var e=this.getAttribs(),i=this.timeFilter.id,s=function(t,e){if(t.f_selected()&&!e.f_selected())return 1;if(e.f_selected()&&!t.f_selected())return-1;var s=t.mappedDataCache[i],a=e.mappedDataCache[i];return null===s||null===a?0:s.getTime()-a.getTime()};e.forEach(function(t){t.sortDirty&&"scatterplot"===this.type&&(t.items.sort(s),this.dom.attribs.selectAll(".timeDot").data(function(t){return t.items},function(t){return t.id()}).order())},this),this.updateAttrib_TimeMinMax(),this.dom.timeBarActive&&this.dom.timeBarActive.each(function(e){var i="translateX("+t.timeScale(e.xMin_Dyn)+"px)";kshf.Util.setTransform(this,i)}).style("width",function(e){return void 0===e.xMin_Dyn?"0px":t.timeScale(e.xMax_Dyn)-t.timeScale(e.xMin_Dyn)+"px"}),e.forEach(function(t){t.sortDirty=!1})},insertTimeChartRows:function(){var t=this;this.browser,this.dom.attribs.append("span").attr("class","scrollbarFiller").style("width",this.browser.scrollWidth+"px"),this.dom.timeLineParts=this.dom.attribs.append("span").attr("class","timeLineParts_Overflow").append("span").attr("class","timeLineParts"),this.options.timeBarShow===!0&&(this.dom.timeLineParts.append("span").attr("class","bar total"),this.dom.timeLineParts.append("span").attr("class","bar active")),this.dom.timeLineParts.selectAll("span.timeDot").data(function(t){return t.items},function(t){return t.id()}).enter().append("span").attr("class",function(e){return t.options.dotClassFunc?"timeDot "+t.options.dotClassFunc(e):"timeDot"}).attr("highlight","false").on("mouseover",function(e){e.highlightAll(),t.dom.selectVertLine.style("left",t.getWidth_Left()+t.timeScale(t.options.timeItemMap(e))+7+"px").style("display","block"),d3.event.stopPropagation()}).on("mouseout",function(e){e.nohighlightAll(),t.dom.selectVertLine.style("display","none"),d3.event.stopPropagation()}).on("click",function(e){var i=e.mappedDataCache[t.timeFilter.id],s=new Date(i),a=new Date(i);if(t.timeticks.range===d3.time.months&&(s.setDate(s.getDate()-15),a=new Date(s),a.setMonth(s.getMonth()+1)),t.timeticks.range===d3.time.years){var r=new Date(t.timeZoom_ms.max).getFullYear()-new Date(t.timeZoom_ms.min).getFullYear();t.options.timeMaxWidth<10*r?(s.setFullYear(s.getFullYear()-5),a.setFullYear(a.getFullYear()+5)):(s.setMonth(s.getMonth()-6),a=new Date(s),a.setMonth(s.getMonth()+12))}t.timeticks.range===d3.time.days&&(s.setDate(s.getDate()-1),a.setDate(s.getDate()+1)),t.timeFilter.active.min=Date.parse(s),t.timeFilter.active.max=Date.parse(a),t.checkTimeFilterLimits(),t.isFiltered_Time()?t.timeFilter.addFilter(!1):t.timeFilter.clearFilter(!1),t.unselectAllAttribs(),t.filterAttrib(d3.select(this.parentNode.parentNode).datum(),!1),d3.event.stopPropagation()}),this.dom.timeBarActive=this.dom.timeLineParts.selectAll("span.bar.active"),this.dom.timeBarTotal=this.dom.timeLineParts.selectAll("span.bar.total"),this.dom.timeDots=this.dom.timeLineParts.selectAll("span.timeDot")},setTimeTicks:function(){this.timeticks={};var t,e=864e5,i=30.4*e,s=365*e;t=void 0!==this.timeZoom_ms?this.timeZoom_ms.max-this.timeZoom_ms.min:this.timeData_dt.max.getTime()-this.timeData_dt.min.getTime();var a=Math.floor(t/e),r=Math.floor(t/i),o=Math.floor(t/s),n=this.timeRange.width/70;o>=n?(this.timeticks.range=d3.time.years,this.timeticks.format=d3.time.format.utc("%Y"),this.timeticks.stepSize=Math.ceil(o/(this.timeRange.width/30))):r>=n?(this.timeticks.range=d3.time.months,this.timeticks.format=d3.time.format.utc("%b '%y"),this.timeticks.stepSize=Math.ceil(r/(this.timeRange.width/60)),this.timeticks.stepSize>12?this.timeticks.stepSize=12:this.timeticks.stepSize>6?this.timeticks.stepSize=6:this.timeticks.stepSize>4&&(this.timeticks.stepSize=4)):(this.timeticks.range=d3.time.days,this.timeticks.format=d3.time.format.utc("%e %b"),this.timeticks.stepSize=Math.ceil(a/n/2),this.timeticks.stepSize>16?this.timeticks.stepSize=32:this.timeticks.stepSize>10?this.timeticks.stepSize=15:this.timeticks.stepSize>5&&(this.timeticks.stepSize=10),this.timeticks.stepSize++),void 0===this.useCurrentTimeMinMax&&(this.timeticks.range===d3.time.years?(this.timeRange.min=Date.UTC(this.timeData_dt.min.getUTCFullYear(),0,1),this.timeRange.max=Date.UTC(this.timeData_dt.max.getUTCFullYear()+1,0,1)):this.timeticks.range===d3.time.months?(this.timeRange.min=Date.UTC(this.timeData_dt.min.getUTCFullYear(),this.timeData_dt.min.getUTCMonth(),1),this.timeRange.max=Date.UTC(this.timeData_dt.max.getUTCFullYear(),this.timeData_dt.max.getUTCMonth()+1,1)):this.timeticks.range===d3.time.days&&(this.timeRange.min=Date.UTC(this.timeData_dt.min.getUTCFullYear(),this.timeData_dt.min.getUTCMonth(),this.timeData_dt.min.getUTCDate()-1),this.timeRange.max=Date.UTC(this.timeData_dt.max.getUTCFullYear(),this.timeData_dt.max.getUTCMonth(),this.timeData_dt.max.getUTCDate()+1)),this.resetTimeZoom_ms(),this.resetTimeFilterActive()),this.updateTimeScale()},updateTimeScale:function(){this.timeScale=d3.time.scale.utc().domain([new Date(this.timeZoom_ms.min),new Date(this.timeZoom_ms.max)]).rangeRound([0,this.timeRange.width])},insertTimeTicks:function(){var t=this,e=this.timeScale.ticks(this.timeticks.range,this.timeticks.stepSize),i=this.dom.timeLabelGroup.selectAll("span.tick").data(e),s=i.enter().append("span").attr("class","tick");i.exit().remove(),s.append("span").attr("class","line"),s.append("span").attr("class","text"),this.dom.labelTicks=this.dom.timeLabelGroup.selectAll("span.tick"),this.dom.labelTicks.selectAll("span.text").text(function(e){return t.timeticks.format(e)}),this.dom.labelTicks.style("left",function(e){return t.timeScale(e)+"px"}),this.insertTimeTicks_timeValues=[],this.dom.timeLabelGroup.selectAll(".text").each(function(e){t.insertTimeTicks_timeValues.push(e)}).on("click",function(e,i){var s=t.insertTimeTicks_timeValues[i],a=t.insertTimeTicks_timeValues[i+1];void 0===a&&(a=t.timeRange.max),t.timeFilter.active={min:s,max:a},t.checkTimeFilterLimits(),t.isFiltered_Time()?t.timeFilter.addFilter(!1):t.timeFilter.clearFilter(!1)})},refreshTimeAxisHeight:function(){this.browser,this.dom.selectVertLine.style("height",this.attribHeight+"px"),this.dom.middleScrollbar.style("height",this.attribHeight+"px"),this.dom.timeChartAxis.selectAll("span.invalidArea").style("margin-top",-this.attribHeight+"px").style("height",this.attribHeight+"px")},insertTimeChartAxis:function(){this.refreshTimeChart()},updateTimeChartBarsDots:function(){var t=this.browser;t.getWidth_LeftPanel()+t.sepWidth;var e=this,i=this.timeFilter.id;this.dom.timeBarTotal.each(function(t){var i="translateX("+e.timeScale(t.xMin)+"px)";kshf.Util.setTransform(this,i)}).style("width",function(t){return e.timeScale(t.xMax)-e.timeScale(t.xMin)+"px"}),this.dom.timeDots.each(function(t){var s="translateX("+(e.timeScale(t.mappedDataCache[i])-5)+"px)";kshf.Util.setTransform(this,s)})},getFilterMinDateText:function(){var t=new Date(this.timeFilter.active.min);return this.timeticks.format(t)},getFilterMaxDateText:function(){var t=new Date(this.timeFilter.active.max);return this.timeticks.format(t)},refreshTimeSlider:function(){var t=this,e=this.timeScale(this.timeFilter.active.min),i=this.timeScale(this.timeFilter.active.max);this.dom.timeSlider.select(".base.total").style("width",this.timeScale.range()[1]+"px"),this.dom.timeSlider.select(".base.active").attr("filtered",this.isFiltered_Time()).each(function(){var t="translate("+e+"px,0) scale("+(i-e)+",1)";kshf.Util.setTransform(this,t)}),this.dom.timeSlider.selectAll(".handle").style("left",function(t){return"min"===t?e-7+"px":i+"px"}).selectAll("span").style("margin-left",function(t){return"min"===t?-(e-4)+"px":"-1px"}).style("width",function(s){return"min"===s?e+"px":t.timeScale.range()[1]-i+"px"})},refreshTimeChart:function(){var t=this.timeScale(this.timeFilter.active.min);this.timeScale(this.timeFilter.active.max),this.timeRange.width-t>190?this.divRoot.select(".config_zoom").style("float","left").style("margin-left",t+this.browser.sepWidth+"px"):this.divRoot.select(".config_zoom").style("float","right"),this.refreshTimeSlider(),this.divRoot.select(".zoom_in").attr("disabled",this.isFiltered_Time()?"false":"true")},checkTimeFilterLimits:function(){if(this.timeFilter.active.min=Math.max(this.timeFilter.active.min,this.timeZoom_ms.min),this.timeFilter.active.max=Math.min(this.timeFilter.active.max,this.timeZoom_ms.max),this.timeFilter.active.min>this.timeFilter.active.max){var t=this.timeFilter.active.min;this.timeFilter.active={min:this.timeFilter.active.max,max:t}}}},kshf.Facet_Interval=function(t,e){this.id=++kshf.num_of_charts,this.browser=t,this.filteredItems=e.items,this.options=e,this.layoutStr=e.layout,this.parentFacet=e.parentFacet,this.height_slider=10,this.height_labels=16,this.height_hist_min=50,this.height_hist_max=100,this.height_bin_top=14,this.barGap=2,this.histogramMargin=12,this.dom={},this.type="interval",this.collapsed=!1,e.collapsed===!0&&(this.collapsed=!0),void 0===this.options.intervalScale&&(this.options.intervalScale="linear"),this.barScale=d3.scale.linear(),this.intervalFilter=t.createFilter({name:this.options.facetTitle,browser:this.browser,filteredItems:this.filteredItems,facet:this,onClear:function(){this.divRoot.attr("filtered",!1),this.resetIntervalFilterActive(),this.refreshIntervalSlider()},onFilter:function(t,e){"true"!==this.divRoot.attr("filtered")&&this.divRoot.attr("filtered",!0);var i=t.active.min,s=t.active.max;t.max_inclusive||(s-=.01);var a=function(t){return t>=i&&s>=t};t.filteredItems.forEach(function(i){var s=i.mappedDataCache[t.id].v;null===s?i.setFilter(t.id,!1):i.setFilter(t.id,a(s)),i.updateWanted(e)},this),this.refreshIntervalSlider()},text_header:this.options.facetTitle,text_item:function(t){return"time"===this.options.intervalScale?"<b>"+this.intervalTickFormat(t.active.min)+"</b> to <b>"+this.intervalTickFormat(t.active.max)+"</b>":"<b>"+t.active.min+"</b> to <b>"+t.active.max+"</b>"}}),this.intervalFilter.how="All";var i=this.intervalFilter.id;this.hasFloat=!1,this.filteredItems.forEach(function(t){var e=this.options.catItemMap(t);null!==e&&(e instanceof Date?this.hasTime=!0:"number"!=typeof e?e=null:this.hasFloat||(this.hasFloat=this.hasFloat||0!==e%1)),t.mappedDataCache[i]={v:e,h:this}},this),this.filteredItems=this.filteredItems.filter(function(t){return null!==t.mappedDataCache[i].v});var s=function(t){return t.mappedDataCache[i].v};return this.intervalRange={min:d3.min(this.filteredItems,s),max:d3.max(this.filteredItems,s)},this.hist_height=65,void 0===this.intervalRange.min?(this.isEmpty=!0,void 0):(this.isEmpty=!1,this.resetIntervalFilterActive(),void 0)},kshf.Facet_Interval.prototype={getWidth:function(){return"left"===this.options.layout||"right"===this.options.layout?this.browser.getWidth_LeftPanel()-this.getWidth_Offset():this.browser.getWidth_Total()-this.getWidth_Offset()},getWidth_Offset:function(){var t=0;return this.parentFacet&&(t+=17),t},getHeight_Header:function(){return void 0==this._height_header&&(this._height_header=this.dom.headerGroup[0][0].offsetHeight),this._height_header},getHeight_Total:function(){return this.collapsed?this.getHeight_Header():this.getHeight_Header()+this.hist_height+this.height_bin_top+this.height_labels+this.height_slider},getFilteredCount:function(){return this.isFiltered()},isFiltered:function(){return this.intervalFilter.active.min!==this.intervalRange.min||this.intervalFilter.active.max!==this.intervalRange.max},getHeight_RangeMax:function(){return this.getHeight_Header()+this.height_hist_max+this.height_bin_top+this.height_labels+this.height_slider},getHeight_RangeMin:function(){return this.getHeight_Header()+this.height_hist_min+this.height_bin_top+this.height_labels+this.height_slider},resetIntervalFilterActive:function(){this.intervalFilter.active={min:this.intervalRange.min,max:this.intervalRange.max}},getMaxBinTotalItems:function(){return d3.max(this.histBins,function(t){return t.length})},getMaxBinActiveItems:function(){return d3.max(this.histBins,function(t){return t.itemCount_Active})},getMinBinActiveItems:function(){return d3.min(this.histBins,function(t){return t.itemCount_Active})},init_DOM:function(){var t,e=this.browser;if(this.parentFacet)t=this.parentFacet.dom.subFacets;else switch(this.options.layout){case"left":t=this.browser.layoutLeft;break;case"right":t=this.browser.layoutRight;break;case"top":t=this.browser.layoutTop;break;case"bottom":t=this.browser.layoutBottom;break;case"bottomleft":t=this.browser.layoutBottom}this.divRoot=t.append("div").attr("class","kshfChart").attr("collapsed",this.collapsed===!1?"false":"true").attr("filtered",!1),this.insertHeader(),this.dom.wrapper=this.divRoot.append("div").attr("class","wrapper"),this.dom.facetInterval=this.dom.wrapper.append("div").attr("class","facetInterval"),this.dom.histogram=this.dom.facetInterval.append("div").attr("class","histogram"),this.dom.histogram_bins=this.dom.histogram.append("div").attr("class","bins"),this.dom.intervalSlider=this.dom.facetInterval.append("div").attr("class","intervalSlider rangeSlider").attr("anim",!0),kshf.Util.insertSlider_do(this.dom.intervalSlider,{range:this.intervalRange,scale:"intervalScale",owner:this,filter:this.intervalFilter,root:e.root}),this.dom.selectedItemValue=this.dom.intervalSlider.select(".selectedItemValue"),this.dom.labelGroup=this.dom.facetInterval.append("div").attr("class","labelGroup")},updateIntervalWidth:function(t){if(void 0===this.intervalRange.width||this.intervalRange.width!==t){switch(this.intervalRange.width=t,this.optimalTickCount=Math.floor(this.intervalRange.width/40),this.options.intervalScale){case"linear":this.intervalScale=d3.scale.linear();break;case"log":this.intervalScale=d3.scale.log().base(2);break;case"time":this.intervalScale=d3.time.scale.utc()}this.intervalScale.domain([this.intervalRange.min,this.intervalRange.max]).range([0,this.intervalRange.width]).nice(this.optimalTickCount).clamp(!0);var e=this.intervalScale.ticks(this.optimalTickCount);if(e=e.filter(function(t){return 0===t%1}),"time"===this.options.intervalScale)this.intervalTickFormat=this.intervalScale.tickFormat(this.optimalTickCount);else if("log"===this.options.intervalScale)for(this.intervalTickFormat=d3.format(".2s");e.length>2*this.optimalTickCount;)e=e.filter(function(t,e){return 0===e%2});else this.intervalTickFormat=d3.format(".2s");void 0===this.intervalTicks||this.intervalTicks.length!==e.length?this.updateTicks(e):(this.barWidth=this.intervalRange.width/(1*(e.length-1)),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.refreshAxisLabels()),this.refreshIntervalSlider()}},updateTicks:function(t){this.intervalTicks=t;var e=this.intervalFilter.id,i=function(t){return t.mappedDataCache[e].v};this.histBins=d3.layout.histogram().bins(this.intervalTicks).value(i)(this.filteredItems);var s=this.intervalScale(t[0]),a=this.intervalScale(t[1]);this.barWidth=a-s,this.updateActiveItems(),this.updateBarScale2Active(),this.insertBins(),this.insertAxisLabels()},hasAttribs:function(){return!1},insertBins:function(){var t=this,e=null,i=this.intervalFilter.id,s=this.dom.histogram_bins.selectAll("span.bar").data(this.histBins,function(t,e){return e});s.exit().remove();var a=s.enter().append("span").attr("class","bin").each(function(t){t.itemCount_Preview=0,t.forEach(function(e){e.mappedDataCache[i].b=t},this)}),r=function(i){t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight",!0),i.forEach(function(e){e.updatePreview(t)}),t.browser.refreshResultPreview(),sendLog&&(e&&clearTimeout(e),e=setTimeout(function(){sendLog(kshf.LOG.FILTER_PREVIEW,{id:t.intervalFilter.id,info:i.x+"x"+i.dx})},1e3)))},o=function(){e&&clearTimeout(e),t.browser.pauseResultPreview||(this.parentNode.setAttribute("highlight",!1),t.browser.clearResultPreview())},n=function(e){return"true"===this.parentNode.getAttribute("filtered")?(this.parentNode.setAttribute("filtered",!1),t.intervalFilter.clearFilter(!0),void 0):(this.parentNode.setAttribute("filtered","true"),t.intervalFilter.dom_HistogramBar=this,t.intervalFilter.active="time"!==t.options.intervalScale?{min:e.x,max:e.x+e.dx}:{min:e.x,max:new Date(e.x.getTime()+e.dx)},t.intervalFilter.max_inclusive=e.x+e.dx===t.intervalRange.max,t.intervalFilter.addFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_INTRVL_BIN,{id:t.intervalFilter.id,info:t.intervalFilter.active.min+"x"+t.intervalFilter.active.max}),void 0)};a.append("span").attr("class","bar total"),a.append("span").attr("class","bar active").on("mouseover",r).on("mouseout",o).on("click",n),a.append("span").attr("class","bar hover").attr("fast",!0),a.append("span").attr("class","item_count").on("mouseover",r).on("mouseout",o).on("click",n),this.dom.histogram_bin=this.dom.histogram_bins.selectAll("span.bin"),this.dom.bars_active=this.dom.histogram_bin.selectAll(".bar.active"),this.dom.bars_total=this.dom.histogram_bin.selectAll(".bar.total"),this.dom.bars_highlight=this.dom.histogram_bin.selectAll(".bar.hover"),this.dom.bars_item_count=this.dom.histogram_bin.selectAll(".item_count"),this.refreshBins_Translate(),this.refreshBars_Total_Scale(),this.refreshBars_Active_Scale(),this.refreshResultPreview(),this.refreshBars_Item_Count(),this.refreshLabelWidth()},updateBarScale2Total:function(){this.barScale=this.barScale.domain([0,this.getMaxBinTotalItems()]).range([0,this.hist_height])},updateBarScale2Active:function(){this.barScale=this.barScale.domain([0,this.getMaxBinActiveItems()]).range([0,this.hist_height])},updateActiveItems:function(){this.histBins.forEach(function(t){t.itemCount_Active=0,t.forEach(function(e){e.isWanted&&t.itemCount_Active++})})},insertAxisLabels:function(){var t=this,e=this.dom.labelGroup.selectAll("span.tick").data(this.intervalTicks),i=e.enter().append("span").attr("class","tick");e.exit().remove(),i.append("span").attr("class","line"),i.append("span").attr("class","text"),this.dom.labelTicks=this.dom.labelGroup.selectAll("span.tick"),this.dom.labelTicks.selectAll("span.text").text(function(e){return t.intervalTickFormat(e)}),this.refreshAxisLabels()},refreshAxisLabels:function(){var t=this;this.dom.labelTicks.style("left",function(e){return t.intervalScale(e)+"px"})},refreshBins_Translate:function(){var t=this;kshf.Util.setTransform(this.dom.histogram_bins[0][0],"translateY("+t.barScale.range()[1]+"px)"),this.dom.histogram_bin.each(function(e){kshf.Util.setTransform(this,"translateX("+t.intervalScale(e.x)+"px)")})},refreshBars_Total_Scale:function(){var t=this.barWidth-2*this.barGap,e=this.barScale;this.dom.bars_total.each(function(i){kshf.Util.setTransform(this,"scale("+t+","+e(i.y)+")")})},refreshBars_Active_Scale:function(){var t=this,e=this.barWidth-2*this.barGap,i=this.barScale;this.dom.bars_active.each(function(t){kshf.Util.setTransform(this,"scale("+e+","+i(t.itemCount_Active)+")")}),this.dom.bars_item_count.each(function(e){kshf.Util.setTransform(this,"translate("+t.barWidth/2+"px,"+-t.barScale(e.itemCount_Active)+"px)")})},clearResultPreview:function(){if(!this.isEmpty&&!this.collapsed){var t=this.barWidth-2*this.barGap;this.dom.bars_highlight.each(function(e){e.itemCount_Preview=0;var i="scale("+t+",0)";kshf.Util.setTransform(this,i)})}},refreshResultPreview:function(){if(!this.isEmpty&&!this.collapsed){var t=this.barScale,e=this.barWidth-2*this.barGap;this.dom.bars_highlight.each(function(i){if(0!==i.itemCount_Preview){var s="scale("+e+","+t(i.itemCount_Preview)+")";kshf.Util.setTransform(this,s)}})}},refreshBars_Item_Count:function(){this.dom.histogram_bin.attr("noitem",function(t){return 0===t.itemCount_Active});var t=kshf.Util.formatForItemCount;this.dom.bars_item_count.text(function(e){return t(e.itemCount_Active)})},refreshIntervalSlider:function(){var t=this,e=this.intervalScale(this.intervalFilter.active.min),i=this.intervalScale(this.intervalFilter.active.max);this.dom.intervalSlider.select(".base.total").style("width",this.intervalScale.range()[1]+"px"),this.dom.intervalSlider.select(".base.active").attr("filtered",this.isFiltered()).each(function(){var t="translate("+e+"px,0) scale("+(i-e)+",1)";kshf.Util.setTransform(this,t)}),this.dom.intervalSlider.selectAll(".handle").each(function(s){t.intervalFilter.active.min===t.intervalRange.min&&(e=t.intervalScale.range()[0]),t.intervalFilter.active.max===t.intervalRange.max&&(i=t.intervalScale.range()[1]);var a="translate("+("min"===s?e:i)+"px,0)";kshf.Util.setTransform(this,a)})},refreshWidth:function(){var t=this.getWidth();if(this.dom.leftHeader.style("width",t+"px"),this.dom.facetInterval.style("width",t+"px"),!this.isEmpty){var e=t-2*this.histogramMargin;this.updateIntervalWidth(e)}},getMaxTotalItemsPerRow:function(){if(!this._maxTotalItemsPerRow){var t=this._dataMap;this._maxTotalItemsPerRow=d3.max(this.getAttribs(),function(e){return null===t(e)?null:e.items.length})}return this._maxTotalItemsPerRow},getMaxBarValueMaxPerAttrib:function(){return 0},setHeight:function(t){var e=t-this.getHeight_Header()-this.height_slider-this.height_labels-this.height_bin_top;this.hist_height=e,this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.refreshResultPreview(),this.refreshHeight()},allAttribsVisible:function(){},refreshHeight:function(){this.dom.histogram.style("height",this.hist_height+15+"px"),this.dom.wrapper.style("height",(this.collapsed?"0":this.hist_height+40)+"px")},setCollapsed:function(t){this.collapsed=t,this.divRoot.attr("collapsed",this.collapsed===!1?"false":"true")},collapseFacet:function(t){this.setCollapsed(t),this.browser.updateLayout_Height(),sendLog&&sendLog(t===!0?kshf.LOG.FACET_COLLAPSE:kshf.LOG.FACET_SHOW,{id:this.id})},insertHeader:function(){var t=this;this.dom.headerGroup=this.divRoot.append("div").attr("class","headerGroup"),this.dom.leftHeader=this.dom.headerGroup.append("span").attr("class","leftHeader");var e=this.dom.leftHeader.append("div").attr("class","chartFirstLineBackground");this.dom.leftHeader.append("div").attr("class","border_line");var i=e.append("div").attr("class","hasLabelWidth").style("position","relative").style("display","inline-block");i.append("span").attr("class","header_label_arrow").attr("title","Show/Hide facet").on("click",function(){t.collapseFacet(!t.collapsed)}).append("span").text("▼"),i.append("span").attr("class","chartFilterButtonParent").append("div").attr("class","chartClearFilterButton rowFilter alone").style("top","calc(40% - 7px)").text("x").attr("title","Remove filter").each(function(){this.tipsy=new Tipsy(this,{gravity:"n",fade:!0,title:function(){return"<span class='big'>x</span class='big'> <span class='action'>Remove</span> filter"}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}).on("click",function(){this.tipsy.hide(),t.intervalFilter.clearFilter(!0),sendLog&&sendLog(kshf.LOG.FILTER_CLEAR_X,{id:t.intervalFilter.id})});var s=this.options.facetTitle;this.parentFacet&&this.parentFacet.hasAttribs()&&(s=s+" <i class='fa fa-chevron-right'></i> "+this.parentFacet.options.facetTitle),i.append("span").attr("class","header_label").html(s).on("click",function(){t.collapsed&&t.collapseFacet(!1)});var a=e.append("span").attr("class","facetIcons");this.options.description&&a.append("span").attr("class","facetDescription fa fa-info-circle").each(function(){this.tipsy=new Tipsy(this,{gravity:"nw",fade:!0,title:function(){return t.options.description}})}).on("mouseover",function(){this.tipsy.show()}).on("mouseout",function(){this.tipsy.hide()}),this.isLinked?a.append("span").attr("class","isLinkedMark fa fa-check-square-o"):this.parentFacet&&a.append("span").attr("class","isLinkedMark fa fa-level-up")},refreshAfterFilter:function(t){var e=this;this.isEmpty||(this.updateActiveItems(),this.refreshBars_Item_Count(),e.animateBarScale2Active())},animateBarScale2Active:function(){var t=this;this.updateBarScale2Active(),this.refreshBins_Translate(),this.refreshBars_Active_Scale(),this.refreshBars_Total_Scale(),this.dom.bars_highlight.attr("fast",null),this.refreshResultPreview(),setTimeout(function(){t.dom.bars_highlight.attr("fast",!0)},700)},refreshHistogram:function(){},refreshLabelWidth:function(){var t=this.getWidth_Offset();this.dom.headerGroup.selectAll(".hasLabelWidth").style("width",this.browser.categoryTextWidth-t+"px")},insertHistogram:function(){},insertTicks:function(){},setSelectedPosition:function(t){this.dom.selectedItemValue.style("left",this.intervalScale(t)+"px").style("display","block")},hideSelectedPosition:function(){this.dom.selectedItemValue.style("display",null)}};